<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving
and Interchange DTD v1.2 20190208//EN" "JATS-archivearticle1.dtd">

<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="1.2" article-type="other">

<front>
<journal-meta>
<journal-id></journal-id>

<journal-title-group>
<journal-title>TBD</journal-title>
</journal-title-group>
<issn></issn>

<publisher>
<publisher-name></publisher-name>
</publisher>
</journal-meta>


<article-meta>


<title-group>
<article-title>Investigating the Spatial Variability in Soil Geochemical
and Colour Properties Across Two Contrasting Land Uses</article-title>
</title-group>

<contrib-group>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">0009-0004-3739-5103</contrib-id>
<name>
<surname>Luna</surname>
<given-names>Maria</given-names>
</name>
<string-name>Maria Luna</string-name>

<email>LUNAMIMA56@brandonu.ca</email>
<role>MSc Thesis</role>
<role>Initial draft of manuscript</role>
<role>Initial data analysis</role>
<role>Sample collection</role>
<role>Lab analysis</role>
<xref ref-type="aff" rid="aff-1">a</xref>
</contrib>
<contrib contrib-type="author" corresp="yes">
<contrib-id contrib-id-type="orcid">0000-0002-9355-9561</contrib-id>
<name>
<surname>Koiter</surname>
<given-names>Alexander J</given-names>
</name>
<string-name>Alexander J Koiter</string-name>

<email>koitera@brandonu.ca</email>
<role>Principle investigator</role>
<role>Primary author</role>
<role>Statistics</role>
<role vocab="https://credit.niso.org" vocab-term="visualization" vocab-term-identifier="https://credit.niso.org/contributor-roles/visualization/">Visualization</role>
<xref ref-type="aff" rid="aff-2">b</xref>
<xref ref-type="corresp" rid="cor-2">&#x002A;</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Lychuk</surname>
<given-names>Taras E</given-names>
</name>
<string-name>Taras E Lychuk</string-name>

<email>taras.lychuk@AGR.GC.CA</email>
<role>Spatial data analysis</role>
<role>Project design</role>
<role>Author</role>
<xref ref-type="aff" rid="aff-3">c</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Waddel</surname>
<given-names>Arnie</given-names>
</name>
<string-name>Arnie Waddel</string-name>

<email>arnie.waddell@AGR.GC.CA</email>
<role>Spatial data analysis</role>
<role>Author</role>
<xref ref-type="aff" rid="aff-3">c</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Moulin</surname>
<given-names>Alan</given-names>
</name>
<string-name>Alan Moulin</string-name>

<email>apmaafc7788@gmail.com</email>
<role>Spatial data analysis</role>
<role>Author</role>
<xref ref-type="aff" rid="aff-3">c</xref>
</contrib>
</contrib-group>
<aff id="aff-1">
<institution-wrap>
<institution>Brandon University, Masters in Environmental and Life
Sciences</institution>
</institution-wrap>
<addr-line>270 18th St</addr-line>
<city>Brandon</city>
<state>MB</state>

<postal-code>R7A 6A9</postal-code>


</aff>
<aff id="aff-2">
<institution-wrap>
<institution>Brandon University, Department of Geography and
Environment</institution>
</institution-wrap>
<addr-line>270 18th St</addr-line>
<city>Brandon</city>
<state>MB</state>

<postal-code>R7A 6A9</postal-code>


</aff>
<aff id="aff-3">
<institution-wrap>
<institution>Agriculture and Agri-Food Canada, Brandon Research and
Development Centre</institution>
</institution-wrap>
<addr-line>2701 Grand Valley Road</addr-line>
<city>Brandon</city>
<state>MB</state>

<postal-code>R7A 5Y3</postal-code>


</aff>
<author-notes>
<corresp id="cor-2">koitera@brandonu.ca</corresp>
</author-notes>









<history></history>


<abstract>
<p>Quantification and accurate assessment of the spatial variability and
distribution of soil physical and biogeochemical properties
(fingerprints) are vital components of agri-environmental research and
modeling, including sediment source fingerprinting. Understanding the
distribution of soil properties at a range of spatial scales is crucial
in the development of appropriate, reliable, and efficient sampling
campaigns. This study was aimed to investigate the spatial variability
in soil geochemical and colour (i.e., spectral reflectance) fingerprints
across two contrasting land uses. The main objectives of this study are
to: 1) quantify the spatial variability of geochemical and colour
fingerprint properties at a field-scale (~ 40 ha) across agricultural
and forested sites; 2) evaluate the spatial variability and distribution
of soil fingerprint properties and its relation to a range of terrain
attributes (e.g., slope); and 3) identify the possible sources of
variation in each land use, primarily environmental factors. A
combination of univariate analysis and geostatistical methods were
applied to analyze the soil geochemistry and colour properties. This
information was used to both quantify and assess the variability in
commonly used fingerprints. Terrain attributes derived from digital
elevation model (DEM) were used to investigate spatial variation of soil
geochemical and colour fingerprint properties. The ability of terrain
attributes to explain the observed variability in soil fingerprints
played an important role across all properties. The present study
suggest that kriging interpolation can directly reveal the spatial
distribution of soil fingerprint properties and quantify the variability
at a field-scale.</p>
</abstract>
<kwd-group kwd-group-type="author">
<kwd>Soil geochemistry</kwd>
<kwd>Soil colour</kwd>
<kwd>Spatial analysis</kwd>
</kwd-group>




</article-meta>

</front>

<body>
<sec id="introduction">
  <title>1 Introduction</title>
</sec>
<sec id="methods">
  <title>2 Methods</title>
  <sec id="site-description">
    <title>2.1 Site description</title>
    <fig id="fig-location_map">
      <caption><p>Figure 1: Map showing the location of the study sites
      within Canada, and the regional land use and
      topography.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="index_files/figure-jats/notebooks-location_map-fig-location_map-output-2.png" />
    </fig>
  </sec>
</sec>
<sec id="results">
  <title>3 Results</title>
  <sec id="univariate-summary">
    <title>3.1 Univariate summary</title>
    <fig id="tbl-univariate-summary">
      <caption><p>Table 1: Summary statistics for for six examples of
      for six examples of geochemical and colour soil properties,
      specific surface area, and organic matter content for each
      site.</p></caption>
      <table-wrap>
        <table>
          <colgroup>
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
          </colgroup>
          <thead>
            <tr>
              <th align="center" id="Element" scope="col">Element</th>
              <th align="center" id="Mean" scope="col">Mean</th>
              <th align="center" id="SD" scope="col">SD</th>
              <th align="center" id="Max" scope="col">Max</th>
              <th align="center" id="Min" scope="col">Min</th>
              <th align="center" id="Skewness" scope="col">Skewness</th>
              <th align="center" id="CV" scope="col">CV</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="center" colspan="7" id="Forest" style="font-weight: bold" scope="colgroup">Forest</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p>Li</p></td>
              <td align="center" headers="Forest  Mean">6.47</td>
              <td align="center" headers="Forest  SD">0.90</td>
              <td align="center" headers="Forest  Max">8.60</td>
              <td align="center" headers="Forest  Min">4.30</td>
              <td align="center" headers="Forest  Skewness">−0.02</td>
              <td align="center" headers="Forest  CV">13.89</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p>Nb</p></td>
              <td align="center" headers="Forest  Mean">0.37</td>
              <td align="center" headers="Forest  SD">0.06</td>
              <td align="center" headers="Forest  Max">0.56</td>
              <td align="center" headers="Forest  Min">0.17</td>
              <td align="center" headers="Forest  Skewness">−0.68</td>
              <td align="center" headers="Forest  CV">17.10</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p>Zn</p></td>
              <td align="center" headers="Forest  Mean">109.55</td>
              <td align="center" headers="Forest  SD">53.27</td>
              <td align="center" headers="Forest  Max">318.00</td>
              <td align="center" headers="Forest  Min">42.00</td>
              <td align="center" headers="Forest  Skewness">1.43</td>
              <td align="center" headers="Forest  CV">48.62</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p><italic>h</italic>*</p></td>
              <td align="center" headers="Forest  Mean">1.13</td>
              <td align="center" headers="Forest  SD">0.05</td>
              <td align="center" headers="Forest  Max">1.23</td>
              <td align="center" headers="Forest  Min">1.06</td>
              <td align="center" headers="Forest  Skewness">0.34</td>
              <td align="center" headers="Forest  CV">4.13</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p><italic>L</italic></p></td>
              <td align="center" headers="Forest  Mean">47.45</td>
              <td align="center" headers="Forest  SD">6.35</td>
              <td align="center" headers="Forest  Max">59.48</td>
              <td align="center" headers="Forest  Min">34.34</td>
              <td align="center" headers="Forest  Skewness">−0.02</td>
              <td align="center" headers="Forest  CV">13.37</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p><italic>v</italic>*</p></td>
              <td align="center" headers="Forest  Mean">4.79</td>
              <td align="center" headers="Forest  SD">1.04</td>
              <td align="center" headers="Forest  Max">6.62</td>
              <td align="center" headers="Forest  Min">2.77</td>
              <td align="center" headers="Forest  Skewness">0.31</td>
              <td align="center" headers="Forest  CV">21.74</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p>SSA</p></td>
              <td align="center" headers="Forest  Mean">763.48</td>
              <td align="center" headers="Forest  SD">133.48</td>
              <td align="center" headers="Forest  Max">1,032.61</td>
              <td align="center" headers="Forest  Min">492.59</td>
              <td align="center" headers="Forest  Skewness">−0.08</td>
              <td align="center" headers="Forest  CV">17.48</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Element"><p>Org</p></td>
              <td align="center" headers="Forest  Mean">11.55</td>
              <td align="center" headers="Forest  SD">5.99</td>
              <td align="center" headers="Forest  Max">26.99</td>
              <td align="center" headers="Forest  Min">1.37</td>
              <td align="center" headers="Forest  Skewness">0.37</td>
              <td align="center" headers="Forest  CV">51.89</td>
            </tr>
            <tr>
              <td align="center" colspan="7" id="Agriculture" style="font-weight: bold" scope="colgroup">Agriculture</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p>Ca</p></td>
              <td align="center" headers="Agriculture  Mean">4.00</td>
              <td align="center" headers="Agriculture  SD">2.19</td>
              <td align="center" headers="Agriculture  Max">8.78</td>
              <td align="center" headers="Agriculture  Min">0.95</td>
              <td align="center" headers="Agriculture  Skewness">0.28</td>
              <td align="center" headers="Agriculture  CV">54.66</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p>Mo</p></td>
              <td align="center" headers="Agriculture  Mean">0.93</td>
              <td align="center" headers="Agriculture  SD">0.41</td>
              <td align="center" headers="Agriculture  Max">2.35</td>
              <td align="center" headers="Agriculture  Min">0.47</td>
              <td align="center" headers="Agriculture  Skewness">1.18</td>
              <td align="center" headers="Agriculture  CV">43.95</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p>U</p></td>
              <td align="center" headers="Agriculture  Mean">1.48</td>
              <td align="center" headers="Agriculture  SD">0.19</td>
              <td align="center" headers="Agriculture  Max">1.94</td>
              <td align="center" headers="Agriculture  Min">1.20</td>
              <td align="center" headers="Agriculture  Skewness">0.59</td>
              <td align="center" headers="Agriculture  CV">12.64</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p><italic>a</italic>*</p></td>
              <td align="center" headers="Agriculture  Mean">3.38</td>
              <td align="center" headers="Agriculture  SD">0.32</td>
              <td align="center" headers="Agriculture  Max">4.15</td>
              <td align="center" headers="Agriculture  Min">2.59</td>
              <td align="center" headers="Agriculture  Skewness">−0.03</td>
              <td align="center" headers="Agriculture  CV">9.53</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p><italic>c</italic>*</p></td>
              <td align="center" headers="Agriculture  Mean">9.47</td>
              <td align="center" headers="Agriculture  SD">1.02</td>
              <td align="center" headers="Agriculture  Max">11.32</td>
              <td align="center" headers="Agriculture  Min">7.17</td>
              <td align="center" headers="Agriculture  Skewness">−0.19</td>
              <td align="center" headers="Agriculture  CV">10.74</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p><italic>h</italic>*</p></td>
              <td align="center" headers="Agriculture  Mean">1.20</td>
              <td align="center" headers="Agriculture  SD">0.01</td>
              <td align="center" headers="Agriculture  Max">1.23</td>
              <td align="center" headers="Agriculture  Min">1.18</td>
              <td align="center" headers="Agriculture  Skewness">0.19</td>
              <td align="center" headers="Agriculture  CV">1.12</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p>SSA</p></td>
              <td align="center" headers="Agriculture  Mean">1,853.02</td>
              <td align="center" headers="Agriculture  SD">187.32</td>
              <td align="center" headers="Agriculture  Max">2,195.72</td>
              <td align="center" headers="Agriculture  Min">1,458.53</td>
              <td align="center" headers="Agriculture  Skewness">0.00</td>
              <td align="center" headers="Agriculture  CV">10.11</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Element"><p>Org</p></td>
              <td align="center" headers="Agriculture  Mean">8.51</td>
              <td align="center" headers="Agriculture  SD">1.37</td>
              <td align="center" headers="Agriculture  Max">11.36</td>
              <td align="center" headers="Agriculture  Min">5.86</td>
              <td align="center" headers="Agriculture  Skewness">0.07</td>
              <td align="center" headers="Agriculture  CV">16.13</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
    </fig>
    <fig id="tbl-univariate2-summary">
      <caption><p>Table 2: Summary statistics for the interpoloated
      values (10m resolution) for six examples of geochemical and colour
      soil properties, specific surface area, organic matter content,
      and seven terrain attributes for each site.</p></caption>
      <table-wrap>
        <table>
          <colgroup>
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
            <col width="14%" />
          </colgroup>
          <thead>
            <tr>
              <th align="center" id="Property" scope="col">Property</th>
              <th align="center" id="Mean" scope="col">Mean</th>
              <th align="center" id="SD" scope="col">SD</th>
              <th align="center" id="Max" scope="col">Max</th>
              <th align="center" id="Min" scope="col">Min</th>
              <th align="center" id="Skewness" scope="col">Skewness</th>
              <th align="center" id="CV" scope="col">CV</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="center" colspan="7" id="Forest" style="font-weight: bold" scope="colgroup">Forest</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Li</p></td>
              <td align="center" headers="Forest  Mean">6.44</td>
              <td align="center" headers="Forest  SD">0.63</td>
              <td align="center" headers="Forest  Max">8.57</td>
              <td align="center" headers="Forest  Min">4.34</td>
              <td align="center" headers="Forest  Skewness">−0.16</td>
              <td align="center" headers="Forest  CV">9.73</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Nb</p></td>
              <td align="center" headers="Forest  Mean">0.37</td>
              <td align="center" headers="Forest  SD">0.03</td>
              <td align="center" headers="Forest  Max">0.43</td>
              <td align="center" headers="Forest  Min">0.29</td>
              <td align="center" headers="Forest  Skewness">−0.32</td>
              <td align="center" headers="Forest  CV">8.32</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Zn</p></td>
              <td align="center" headers="Forest  Mean">111.46</td>
              <td align="center" headers="Forest  SD">43.21</td>
              <td align="center" headers="Forest  Max">317.76</td>
              <td align="center" headers="Forest  Min">42.15</td>
              <td align="center" headers="Forest  Skewness">1.11</td>
              <td align="center" headers="Forest  CV">38.76</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p><italic>h</italic>*</p></td>
              <td align="center" headers="Forest  Mean">1.13</td>
              <td align="center" headers="Forest  SD">0.04</td>
              <td align="center" headers="Forest  Max">1.23</td>
              <td align="center" headers="Forest  Min">1.06</td>
              <td align="center" headers="Forest  Skewness">0.30</td>
              <td align="center" headers="Forest  CV">3.38</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p><italic>L</italic></p></td>
              <td align="center" headers="Forest  Mean">47.25</td>
              <td align="center" headers="Forest  SD">4.72</td>
              <td align="center" headers="Forest  Max">59.48</td>
              <td align="center" headers="Forest  Min">34.38</td>
              <td align="center" headers="Forest  Skewness">0.10</td>
              <td align="center" headers="Forest  CV">9.98</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p><italic>v</italic>*</p></td>
              <td align="center" headers="Forest  Mean">4.78</td>
              <td align="center" headers="Forest  SD">0.73</td>
              <td align="center" headers="Forest  Max">6.62</td>
              <td align="center" headers="Forest  Min">2.77</td>
              <td align="center" headers="Forest  Skewness">0.28</td>
              <td align="center" headers="Forest  CV">15.28</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>SSA</p></td>
              <td align="center" headers="Forest  Mean">760.40</td>
              <td align="center" headers="Forest  SD">120.58</td>
              <td align="center" headers="Forest  Max">1,102.95</td>
              <td align="center" headers="Forest  Min">483.70</td>
              <td align="center" headers="Forest  Skewness">0.12</td>
              <td align="center" headers="Forest  CV">15.86</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Org</p></td>
              <td align="center" headers="Forest  Mean">11.53</td>
              <td align="center" headers="Forest  SD">1.97</td>
              <td align="center" headers="Forest  Max">16.13</td>
              <td align="center" headers="Forest  Min">7.37</td>
              <td align="center" headers="Forest  Skewness">−0.12</td>
              <td align="center" headers="Forest  CV">17.10</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Elevation</p></td>
              <td align="center" headers="Forest  Mean">369.28</td>
              <td align="center" headers="Forest  SD">3.34</td>
              <td align="center" headers="Forest  Max">377.24</td>
              <td align="center" headers="Forest  Min">358.29</td>
              <td align="center" headers="Forest  Skewness">−0.21</td>
              <td align="center" headers="Forest  CV">0.90</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Rel.
              Slope Position</p></td>
              <td align="center" headers="Forest  Mean">0.22</td>
              <td align="center" headers="Forest  SD">0.26</td>
              <td align="center" headers="Forest  Max">1.00</td>
              <td align="center" headers="Forest  Min">−0.12</td>
              <td align="center" headers="Forest  Skewness">1.55</td>
              <td align="center" headers="Forest  CV">116.75</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Vert.
              Dist. Channel</p></td>
              <td align="center" headers="Forest  Mean">0.47</td>
              <td align="center" headers="Forest  SD">0.57</td>
              <td align="center" headers="Forest  Max">4.90</td>
              <td align="center" headers="Forest  Min">−0.67</td>
              <td align="center" headers="Forest  Skewness">2.75</td>
              <td align="center" headers="Forest  CV">122.69</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>SAGA
              Wetness Index</p></td>
              <td align="center" headers="Forest  Mean">6.00</td>
              <td align="center" headers="Forest  SD">1.26</td>
              <td align="center" headers="Forest  Max">9.96</td>
              <td align="center" headers="Forest  Min">0.09</td>
              <td align="center" headers="Forest  Skewness">−0.86</td>
              <td align="center" headers="Forest  CV">20.92</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Catchment
              Area</p></td>
              <td align="center" headers="Forest  Mean">565.06</td>
              <td align="center" headers="Forest  SD">5,109.73</td>
              <td align="center" headers="Forest  Max">209,263.22</td>
              <td align="center" headers="Forest  Min">0.67</td>
              <td align="center" headers="Forest  Skewness">17.83</td>
              <td align="center" headers="Forest  CV">904.28</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Profile
              Curvature</p></td>
              <td align="center" headers="Forest  Mean">0.00</td>
              <td align="center" headers="Forest  SD">0.03</td>
              <td align="center" headers="Forest  Max">0.45</td>
              <td align="center" headers="Forest  Min">−0.47</td>
              <td align="center" headers="Forest  Skewness">−0.34</td>
              <td align="center" headers="Forest  CV">−15,245.25</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property"><p>Plan
              Curvature</p></td>
              <td align="center" headers="Forest  Mean">0.00</td>
              <td align="center" headers="Forest  SD">0.01</td>
              <td align="center" headers="Forest  Max">0.30</td>
              <td align="center" headers="Forest  Min">−0.26</td>
              <td align="center" headers="Forest  Skewness">0.56</td>
              <td align="center" headers="Forest  CV">3,382.34</td>
            </tr>
            <tr>
              <td align="center" colspan="7" id="Agriculture" style="font-weight: bold" scope="colgroup">Agriculture</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Ca</p></td>
              <td align="center" headers="Agriculture  Mean">4.10</td>
              <td align="center" headers="Agriculture  SD">2.09</td>
              <td align="center" headers="Agriculture  Max">9.11</td>
              <td align="center" headers="Agriculture  Min">1.03</td>
              <td align="center" headers="Agriculture  Skewness">0.09</td>
              <td align="center" headers="Agriculture  CV">51.01</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Mo</p></td>
              <td align="center" headers="Agriculture  Mean">0.89</td>
              <td align="center" headers="Agriculture  SD">0.31</td>
              <td align="center" headers="Agriculture  Max">1.96</td>
              <td align="center" headers="Agriculture  Min">0.51</td>
              <td align="center" headers="Agriculture  Skewness">0.76</td>
              <td align="center" headers="Agriculture  CV">35.03</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>U</p></td>
              <td align="center" headers="Agriculture  Mean">1.46</td>
              <td align="center" headers="Agriculture  SD">0.14</td>
              <td align="center" headers="Agriculture  Max">1.81</td>
              <td align="center" headers="Agriculture  Min">1.24</td>
              <td align="center" headers="Agriculture  Skewness">0.25</td>
              <td align="center" headers="Agriculture  CV">9.24</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p><italic>a</italic>*</p></td>
              <td align="center" headers="Agriculture  Mean">3.34</td>
              <td align="center" headers="Agriculture  SD">0.22</td>
              <td align="center" headers="Agriculture  Max">3.93</td>
              <td align="center" headers="Agriculture  Min">2.77</td>
              <td align="center" headers="Agriculture  Skewness">0.03</td>
              <td align="center" headers="Agriculture  CV">6.60</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p><italic>c</italic>*</p></td>
              <td align="center" headers="Agriculture  Mean">9.35</td>
              <td align="center" headers="Agriculture  SD">0.76</td>
              <td align="center" headers="Agriculture  Max">11.08</td>
              <td align="center" headers="Agriculture  Min">7.39</td>
              <td align="center" headers="Agriculture  Skewness">−0.16</td>
              <td align="center" headers="Agriculture  CV">8.17</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p><italic>h</italic>*</p></td>
              <td align="center" headers="Agriculture  Mean">1.20</td>
              <td align="center" headers="Agriculture  SD">0.01</td>
              <td align="center" headers="Agriculture  Max">1.23</td>
              <td align="center" headers="Agriculture  Min">1.18</td>
              <td align="center" headers="Agriculture  Skewness">−0.13</td>
              <td align="center" headers="Agriculture  CV">0.72</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>SSA</p></td>
              <td align="center" headers="Agriculture  Mean">1,867.79</td>
              <td align="center" headers="Agriculture  SD">129.71</td>
              <td align="center" headers="Agriculture  Max">2,056.35</td>
              <td align="center" headers="Agriculture  Min">1,579.16</td>
              <td align="center" headers="Agriculture  Skewness">−0.43</td>
              <td align="center" headers="Agriculture  CV">6.94</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Org</p></td>
              <td align="center" headers="Agriculture  Mean">8.62</td>
              <td align="center" headers="Agriculture  SD">0.68</td>
              <td align="center" headers="Agriculture  Max">10.30</td>
              <td align="center" headers="Agriculture  Min">7.08</td>
              <td align="center" headers="Agriculture  Skewness">0.34</td>
              <td align="center" headers="Agriculture  CV">7.89</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Elevation</p></td>
              <td align="center" headers="Agriculture  Mean">309.92</td>
              <td align="center" headers="Agriculture  SD">0.59</td>
              <td align="center" headers="Agriculture  Max">311.82</td>
              <td align="center" headers="Agriculture  Min">309.01</td>
              <td align="center" headers="Agriculture  Skewness">0.62</td>
              <td align="center" headers="Agriculture  CV">0.19</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Rel.
              Slope Position</p></td>
              <td align="center" headers="Agriculture  Mean">0.72</td>
              <td align="center" headers="Agriculture  SD">0.34</td>
              <td align="center" headers="Agriculture  Max">28.79</td>
              <td align="center" headers="Agriculture  Min">−33.19</td>
              <td align="center" headers="Agriculture  Skewness">−3.62</td>
              <td align="center" headers="Agriculture  CV">47.84</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Vert.
              Dist. Channel</p></td>
              <td align="center" headers="Agriculture  Mean">0.06</td>
              <td align="center" headers="Agriculture  SD">0.04</td>
              <td align="center" headers="Agriculture  Max">0.33</td>
              <td align="center" headers="Agriculture  Min">0.00</td>
              <td align="center" headers="Agriculture  Skewness">1.07</td>
              <td align="center" headers="Agriculture  CV">73.73</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>SAGA
              Wetness Index</p></td>
              <td align="center" headers="Agriculture  Mean">9.64</td>
              <td align="center" headers="Agriculture  SD">0.72</td>
              <td align="center" headers="Agriculture  Max">11.27</td>
              <td align="center" headers="Agriculture  Min">7.63</td>
              <td align="center" headers="Agriculture  Skewness">−0.11</td>
              <td align="center" headers="Agriculture  CV">7.43</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Catchment
              Area</p></td>
              <td align="center" headers="Agriculture  Mean">475.21</td>
              <td align="center" headers="Agriculture  SD">1,884.43</td>
              <td align="center" headers="Agriculture  Max">41,848.99</td>
              <td align="center" headers="Agriculture  Min">1.05</td>
              <td align="center" headers="Agriculture  Skewness">10.24</td>
              <td align="center" headers="Agriculture  CV">396.55</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Profile
              Curvature</p></td>
              <td align="center" headers="Agriculture  Mean">0.00</td>
              <td align="center" headers="Agriculture  SD">0.00</td>
              <td align="center" headers="Agriculture  Max">0.00</td>
              <td align="center" headers="Agriculture  Min">0.00</td>
              <td align="center" headers="Agriculture  Skewness">−0.15</td>
              <td align="center" headers="Agriculture  CV">−5,332.23</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property"><p>Plan
              Curvature</p></td>
              <td align="center" headers="Agriculture  Mean">0.00</td>
              <td align="center" headers="Agriculture  SD">0.00</td>
              <td align="center" headers="Agriculture  Max">0.00</td>
              <td align="center" headers="Agriculture  Min">0.00</td>
              <td align="center" headers="Agriculture  Skewness">0.23</td>
              <td align="center" headers="Agriculture  CV">27,643.82</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
    </fig>
  </sec>
  <sec id="spatial-analysis">
    <title>3.2 Spatial analysis</title>
    <fig id="tbl-geochem-semivariogram">
      <caption><p>Table 3: Geostatistical parameters of the fitted
      semivariogram models for six examples of geochemical and colour
      fingerprint properties for each site.</p></caption>
      <table-wrap>
        <table>
          <thead>
            <tr>
              <th align="center" id="Property" scope="col">Property</th>
              <th align="center" id="ModelU003CspanU0020classU003DU0022gt_footnote_marksU0022U0020styleU003DU0022white-spaceU003AnowrapU003Bfont-styleU003AitalicU003Bfont-weightU003AnormalU003BU0022U003EU003CsupU003E1U003CU002FsupU003EU003CU002FspanU003E" scope="col">Model<named-content content-type="gt_footnote_marks"><sup>1</sup></named-content></th>
              <th align="center" id="NuggetU0020U0028CoU0029" scope="col">Nugget
              (Co)</th>
              <th align="center" id="SillU0020U0028CoU0029" scope="col">Sill
              (Co)</th>
              <th align="center" id="RangeU0020U0028mU0029" scope="col">Range
              (m)</th>
              <th align="center" id="CU002FU0028CU0020U002BU0020CoU0029U0020U0028U0025U0029" scope="col">C/(C
              + Co) (%)</th>
              <th align="center" id="ClassU003CspanU0020classU003DU0022gt_footnote_marksU0022U0020styleU003DU0022white-spaceU003AnowrapU003Bfont-styleU003AitalicU003Bfont-weightU003AnormalU003BU0022U003EU003CsupU003E2U003CU002FsupU003EU003CU002FspanU003E" scope="col">Class<named-content content-type="gt_footnote_marks"><sup>2</sup></named-content></th>
              <th align="center" id="R2" scope="col">R2</th>
              <th align="center" id="RMSE" scope="col">RMSE</th>
            </tr>
          </thead>
          <tfoot>
            <tr>
              <td align="center" colspan="9"><named-content content-type="gt_footnote_marks"><sup>1</sup></named-content>
              Models are all isotropic.</td>
            </tr>
            <tr>
              <td align="center" colspan="9"><named-content content-type="gt_footnote_marks"><sup>2</sup></named-content>
              S = strong spatial dependency (C/(C + Co) % &gt;75); M =
              moderate spatial dependency (C/(C + Co) % between 75 and
              25).</td>
            </tr>
          </tfoot>
          <tbody>
            <tr>
              <td align="center" colspan="9" id="Agriculture" style="font-weight: bold" scope="colgroup">Agriculture</td>
            </tr>
            <tr>
              <td align="center" headers="Agriculture  Property">Ca</td>
              <td align="center" headers="Agriculture  Model">Exp</td>
              <td align="center" headers="Agriculture  Nugget (Co)">0</td>
              <td align="center" headers="Agriculture  Sill (Co)">1.49</td>
              <td align="center" headers="Agriculture  Range (m)">72.52</td>
              <td align="center" headers="Agriculture  C/(C + Co) (%)">0</td>
              <td align="center" headers="Agriculture  Class">S</td>
              <td align="center" headers="Agriculture  R2">0.27</td>
              <td align="center" headers="Agriculture  RMSE">1.8</td>
            </tr>
            <tr>
              <td align="center" colspan="9" id="Forest" style="font-weight: bold" scope="colgroup">Forest</td>
            </tr>
            <tr>
              <td align="center" headers="Forest  Property">Ca</td>
              <td align="center" headers="Forest  Model">Exp</td>
              <td align="center" headers="Forest  Nugget (Co)">0</td>
              <td align="center" headers="Forest  Sill (Co)">1.49</td>
              <td align="center" headers="Forest  Range (m)">72.52</td>
              <td align="center" headers="Forest  C/(C + Co) (%)">0</td>
              <td align="center" headers="Forest  Class">S</td>
              <td align="center" headers="Forest  R2">0.27</td>
              <td align="center" headers="Forest  RMSE">1.8</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
    </fig>
    <fig id="fig-ag_map">
      <caption><p>Figure 2: Kriged map of select colour
      (<italic>a*</italic>, <italic>c*</italic>, <italic>h*</italic>)
      and geochemical (Ca, Mo, U) properties across the agricultural
      site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="index_files/figure-jats/notebooks-soil_property_maps-fig-ag_map-output-1.png" />
    </fig>
    <fig id="fig-ag_map2">
      <caption><p>Figure 3: Kriged map of organic matter content (%),
      specific surface area (m2 kg-1), and elevation (m) across the
      agricultural site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="index_files/figure-jats/notebooks-soil_property_maps-fig-ag_map2-output-1.png" />
    </fig>
    <fig id="fig-forest_map">
      <caption><p>Figure 4: Kriged map of select colour
      (<italic>h*</italic>, <italic>c*</italic>, <italic>v*</italic>)
      and geochemical (Li, Nb, Zn) properties across the forested
      site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="index_files/figure-jats/notebooks-soil_property_maps-fig-forest_map-output-1.png" />
    </fig>
    <fig id="fig-forest_map2">
      <caption><p>Figure 5: Kriged map of organic matter content (%),
      specific surface area (m2 kg-1), and elevation (m) across the
      forested site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="index_files/figure-jats/notebooks-soil_property_maps-fig-forest_map2-output-1.png" />
    </fig>
    <fig id="fig-rf-results">
      <caption><p>Figure 6: Heat map of the Random Forest regresssion
      results showing the ranking of the importance of terrain
      attributes (based on % increase in Mean Squared Error) in
      explaining the spatial variabilty of selected colour and
      geochemical properties within the agricultural and forested sites.
      Top panel shows an average ranking for each site and across both
      sites.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="index_files/figure-jats/notebooks-RF_results-fig-rf-results-output-1.png" />
    </fig>
  </sec>
</sec>
<sec id="references">
  <title>References</title>
</sec>
<sec id="supplemental-materials">
  <title>Supplemental materials</title>
  <graphic mimetype="image" mime-subtype="png" xlink:href="images/geo_summary.png" />
  <p>Summary statistics of all measured geochemical soil properties at
  both sites. Error bars represent 1SD and the numeric values indicate
  the CV.</p>
  <graphic mimetype="image" mime-subtype="png" xlink:href="images/colour_summary.png" />
  <p>Summary statistics of all measured colour soil properties at both
  sites. Error bars represent 1SD and the numeric values indicate the
  CV.</p>
</sec>
</body>

<back>
</back>

<sub-article article-type="notebook" id="nb-1-nb-1">
<front-stub>
<title-group>
<article-title>Univariate summary</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-1">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-1" specific-use="notebook-code">
  <code language="r script">library(tidyverse)
  </code>
  <code language="r script">library(gt)
library(sf)
  </code>
  <code language="r script">library(terra)
  </code>
  <sec id="nb-code-cell-1-output-0-nb-1" specific-use="notebook-output">
  <preformat>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</preformat>
  </sec>
  <sec id="nb-code-cell-1-output-1-nb-1" specific-use="notebook-output">
  <preformat>Linking to GEOS 3.10.2, GDAL 3.4.3, PROJ 8.2.1; sf_use_s2() is TRUE</preformat>
  </sec>
  <sec id="nb-code-cell-1-output-2-nb-1" specific-use="notebook-output">
  <preformat>terra 1.7.39

Attaching package: 'terra'

The following object is masked from 'package:tidyr':

    extract</preformat>
  </sec>
  </sec>
</sec>
<sec id="load-in-data-nb-1">
  <title>load in data</title>
  <sec id="nb-code-cell-2-nb-1" specific-use="notebook-code">
  <code language="r script">data &lt;- read_csv(here::here(&quot;./notebooks/soil_data.csv&quot;))
  </code>
  <sec id="nb-code-cell-2-output-0-nb-1" specific-use="notebook-output">
  <preformat>Rows: 6078 Columns: 5
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): site, element, group
dbl (2): sample_number, value

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
  </sec>
  </sec>
  <sec id="summarize-nb-1">
    <title>Summarize</title>
    <sec id="nb-code-cell-3-nb-1" specific-use="notebook-code">
    <code language="r script">data_summary &lt;- data %&gt;%
  group_by(element) %&gt;%
  group_by(element, site, group) %&gt;%
  summarise(mean = mean(value, na.rm = T),
            sd = sd(value, na.rm = T),
            max = max(value, na.rm = T),
            min = min(value, na.rm = T),
            se = sd(value)/ sqrt(length(value)),
            skewness = moments::skewness(value),
            cv = sd(value, na.rm = TRUE) / mean(value, na.rm = TRUE) * 100, .groups = &quot;drop&quot;) 
    </code>
    </sec>
    <sec id="max-min-scaling-nb-1">
      <title>Max-min scaling</title>
      <sec id="nb-code-cell-4-nb-1" specific-use="notebook-code">
      <code language="r script">data2 &lt;- data %&gt;%
  group_by(element) %&gt;%
  mutate(value2 = (value - min(value, na.rm = T)) / (max(value, na.rm = T) - min(value, na.rm = T))) %&gt;%
  group_by(element, site, group) %&gt;%
  summarise(mean = mean(value2, na.rm = T),
            sd = sd(value2, na.rm = T),
            max = max(value2, na.rm = T),
            min = min(value2, na.rm = T),
            se = sd(value2)/ sqrt(length(value2)),
            skewness = moments::skewness(value2),
            cv = sd(value, na.rm = TRUE) / mean(value, na.rm = TRUE) * 100, .groups = &quot;drop&quot;) %&gt;%
  mutate(spacer = case_when(site == &quot;Forest&quot; ~ 1.1,
                            site == &quot;Agriculture&quot;~ 1.2))
      </code>
      </sec>
    </sec>
  </sec>
  <sec id="geochemistry-nb-1">
    <title>Geochemistry</title>
    <sec id="plot-prep-nb-1">
      <title>plot prep</title>
      <sec id="nb-code-cell-5-nb-1" specific-use="notebook-code">
      <code language="r script">geo &lt;- data2 %&gt;%
  filter(group == &quot;geochem&quot;) %&gt;%
  mutate(facet = case_when(element %in% c(&quot;Ag&quot;, &quot;Al&quot;, &quot;As&quot;,&quot;B&quot;,&quot;Ba&quot;,&quot;Be&quot;,&quot;Bi&quot;,&quot;Ca&quot;,&quot;Cd&quot;,&quot;Ce&quot;,&quot;Co&quot;, &quot;Cr&quot;, &quot;Cs&quot;, &quot;Cu&quot;, &quot;Fe&quot;, &quot;Ga&quot;, &quot;Hf&quot;, &quot;Hg&quot;, &quot;In&quot;, &quot;K&quot;, &quot;La&quot;, &quot;Li&quot;) ~ &quot;Geomchemistry A-L&quot;,
                          element %in% c(&quot;Mg&quot;, &quot;Mn&quot;, &quot;Mo&quot;, &quot;Nb&quot;, &quot;Ni&quot;, &quot;P&quot;, &quot;Pb&quot;, &quot;Rb&quot;, &quot;S&quot;, &quot;Sb&quot;, &quot;Sc&quot;, &quot;Se&quot;, &quot;Sn&quot;, &quot;Sr&quot;, &quot;Te&quot;, &quot;Th&quot;, &quot;Tl&quot;, &quot;U&quot;, &quot;V&quot;, &quot;Y&quot;, &quot;Zn&quot;, &quot;Zr&quot;) ~ &quot;Geomchemistry M-Z&quot;,
                          TRUE~ NA)) %&gt;%
  mutate(bar = rep(c(rep(Inf, 2), rep(0, 2)), n()/4)) %&gt;%
  pivot_longer(cols = c(mean, max, min), names_to = &quot;variable&quot;) 

geo2 &lt;- data2 %&gt;%
  filter(group == &quot;geochem&quot;) %&gt;%
    mutate(facet = case_when(element %in% c(&quot;Ag&quot;, &quot;Al&quot;, &quot;As&quot;,&quot;B&quot;,&quot;Ba&quot;,&quot;Be&quot;,&quot;Bi&quot;,&quot;Ca&quot;,&quot;Cd&quot;,&quot;Ce&quot;,&quot;Co&quot;, &quot;Cr&quot;, &quot;Cs&quot;, &quot;Cu&quot;, &quot;Fe&quot;, &quot;Ga&quot;, &quot;Hf&quot;, &quot;Hg&quot;, &quot;In&quot;, &quot;K&quot;, &quot;La&quot;, &quot;Li&quot;) ~ &quot;Geomchemistry A-L&quot;,
                          element %in% c(&quot;Mg&quot;, &quot;Mn&quot;, &quot;Mo&quot;, &quot;Nb&quot;, &quot;Ni&quot;, &quot;P&quot;, &quot;Pb&quot;, &quot;Rb&quot;, &quot;S&quot;, &quot;Sb&quot;, &quot;Sc&quot;, &quot;Se&quot;, &quot;Sn&quot;, &quot;Sr&quot;, &quot;Te&quot;, &quot;Th&quot;, &quot;Tl&quot;, &quot;U&quot;, &quot;V&quot;, &quot;Y&quot;, &quot;Zn&quot;, &quot;Zr&quot;) ~ &quot;Geomchemistry M-Z&quot;,
                          TRUE~ NA)) %&gt;%
  mutate(bar = rep(c(rep(Inf, 2), rep(0, 2)), n()/4))

geo3 &lt;- data2 %&gt;%
  filter(group == &quot;geochem&quot;) %&gt;%
    mutate(facet = case_when(element %in% c(&quot;Ag&quot;, &quot;Al&quot;, &quot;As&quot;,&quot;B&quot;,&quot;Ba&quot;,&quot;Be&quot;,&quot;Bi&quot;,&quot;Ca&quot;,&quot;Cd&quot;,&quot;Ce&quot;,&quot;Co&quot;, &quot;Cr&quot;, &quot;Cs&quot;, &quot;Cu&quot;, &quot;Fe&quot;, &quot;Ga&quot;, &quot;Hf&quot;, &quot;Hg&quot;, &quot;In&quot;, &quot;K&quot;, &quot;La&quot;, &quot;Li&quot;) ~ &quot;Geomchemistry A-L&quot;,
                          element %in% c(&quot;Mg&quot;, &quot;Mn&quot;, &quot;Mo&quot;, &quot;Nb&quot;, &quot;Ni&quot;, &quot;P&quot;, &quot;Pb&quot;, &quot;Rb&quot;, &quot;S&quot;, &quot;Sb&quot;, &quot;Sc&quot;, &quot;Se&quot;, &quot;Sn&quot;, &quot;Sr&quot;, &quot;Te&quot;, &quot;Th&quot;, &quot;Tl&quot;, &quot;U&quot;, &quot;V&quot;, &quot;Y&quot;, &quot;Zn&quot;, &quot;Zr&quot;) ~ &quot;Geomchemistry M-Z&quot;,
                          TRUE~ NA)) %&gt;%
  mutate(bar = rep(c(rep(-Inf, 2), rep(0, 2)), n()/4))
      </code>
      </sec>
    </sec>
    <sec id="plot-nb-1">
      <title>plot</title>
      <sec id="nb-code-cell-6-nb-1" specific-use="notebook-code">
      <code language="r script">
p1 &lt;- ggplot() +
  theme_bw(base_size = 12) +
  geom_bar(data = geo2, aes(x=element, y = bar), fill =&quot;grey20&quot;, position=&quot;identity&quot;, stat = &quot;identity&quot;, alpha = 0.1) +
  geom_bar(data = geo3, aes(x=element, y = bar), fill =&quot;grey20&quot;, position=&quot;identity&quot;, stat = &quot;identity&quot;, alpha = 0.1) +
  geom_errorbar(data = geo2, aes(x = element, ymin = mean - sd, ymax = mean + sd, colour = site), width = .1, position = position_dodge(width = 0.5)) +
  geom_point(data = filter(geo, variable == &quot;mean&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 1.5) +
  geom_point(data = filter(geo, variable == &quot;max&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 1.5) +
  geom_point(data = filter(geo, variable == &quot;min&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 1.5) +
  geom_text(data = geo3, aes(x = element, y = spacer, colour = site, label = formatC(cv, digits = 1, format = &quot;f&quot;)), show.legend = FALSE, size = 3) +
  guides(color=guide_legend(override.aes=list(shape=NA))) +
  scale_shape_manual(values=c(3, 19, 4)) +
  scale_color_viridis_d(begin = 0.2, end = 0.7) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(legend.position = &quot;bottom&quot;,
        legend.title = element_blank()) +
  labs(y = &quot;Scaled Concentration&quot;, x = &quot;Element&quot;) +
  facet_wrap(~facet, ncol = 1, scales = &quot;free_x&quot;)

#ggsave(plot = p1, filename = here::here(&quot;./images/geo_summary.png&quot;))
      </code>
      </sec>
    </sec>
  </sec>
  <sec id="plot2-nb-1">
    <title>Plot2</title>
    <sec id="nb-code-cell-7-nb-1" specific-use="notebook-code">
    <code language="r script">ggplot(data = filter(data, group == &quot;geochem&quot;), aes(x = site, y = value, fill = site))+
  geom_boxplot() +
  theme_bw(base_size = 12) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7) +
  theme(legend.position = &quot;none&quot;,
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(x = &quot;Site&quot;, y = &quot;Concentration&quot;) +
  facet_wrap(~element, scales = &quot;free_y&quot;)
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="univariate_summary_files/figure-jats/unnamed-chunk-7-1.png" />
    </sec>
    <sec id="table-nb-1">
      <title>Table</title>
      <sec id="nb-code-cell-8-nb-1" specific-use="notebook-code">
      <code language="r script">geo_tab &lt;- data_summary %&gt;%
  filter(group == &quot;geochem&quot;) %&gt;%
  select(-group) 

knitr::kable(geo_tab, digits = 3)
      </code>
      <table-wrap>
        <table>
          <colgroup>
            <col width="11%" />
            <col width="16%" />
            <col width="11%" />
            <col width="11%" />
            <col width="12%" />
            <col width="11%" />
            <col width="9%" />
            <col width="12%" />
            <col width="9%" />
          </colgroup>
          <thead>
            <tr>
              <th align="left">element</th>
              <th align="left">site</th>
              <th align="right">mean</th>
              <th align="right">sd</th>
              <th align="right">max</th>
              <th align="right">min</th>
              <th align="right">se</th>
              <th align="right">skewness</th>
              <th align="right">cv</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">Ag</td>
              <td align="left">Agriculture</td>
              <td align="right">0.106</td>
              <td align="right">0.021</td>
              <td align="right">0.220</td>
              <td align="right">0.080</td>
              <td align="right">0.003</td>
              <td align="right">3.302</td>
              <td align="right">19.927</td>
            </tr>
            <tr>
              <td align="left">Ag</td>
              <td align="left">Forest</td>
              <td align="right">0.072</td>
              <td align="right">0.015</td>
              <td align="right">0.130</td>
              <td align="right">0.040</td>
              <td align="right">0.002</td>
              <td align="right">1.109</td>
              <td align="right">20.428</td>
            </tr>
            <tr>
              <td align="left">Al</td>
              <td align="left">Agriculture</td>
              <td align="right">1.274</td>
              <td align="right">0.090</td>
              <td align="right">1.430</td>
              <td align="right">0.970</td>
              <td align="right">0.013</td>
              <td align="right">-0.607</td>
              <td align="right">7.099</td>
            </tr>
            <tr>
              <td align="left">Al</td>
              <td align="left">Forest</td>
              <td align="right">0.668</td>
              <td align="right">0.109</td>
              <td align="right">0.890</td>
              <td align="right">0.440</td>
              <td align="right">0.016</td>
              <td align="right">0.229</td>
              <td align="right">16.391</td>
            </tr>
            <tr>
              <td align="left">As</td>
              <td align="left">Agriculture</td>
              <td align="right">9.351</td>
              <td align="right">2.067</td>
              <td align="right">14.200</td>
              <td align="right">6.900</td>
              <td align="right">0.295</td>
              <td align="right">1.008</td>
              <td align="right">22.101</td>
            </tr>
            <tr>
              <td align="left">As</td>
              <td align="left">Forest</td>
              <td align="right">4.845</td>
              <td align="right">1.436</td>
              <td align="right">8.100</td>
              <td align="right">1.700</td>
              <td align="right">0.205</td>
              <td align="right">0.270</td>
              <td align="right">29.640</td>
            </tr>
            <tr>
              <td align="left">B</td>
              <td align="left">Agriculture</td>
              <td align="right">31.633</td>
              <td align="right">3.734</td>
              <td align="right">40.000</td>
              <td align="right">30.000</td>
              <td align="right">0.533</td>
              <td align="right">1.822</td>
              <td align="right">11.805</td>
            </tr>
            <tr>
              <td align="left">B</td>
              <td align="left">Forest</td>
              <td align="right">15.918</td>
              <td align="right">4.966</td>
              <td align="right">20.000</td>
              <td align="right">10.000</td>
              <td align="right">0.709</td>
              <td align="right">-0.374</td>
              <td align="right">31.196</td>
            </tr>
            <tr>
              <td align="left">Ba</td>
              <td align="left">Agriculture</td>
              <td align="right">154.898</td>
              <td align="right">19.378</td>
              <td align="right">190.000</td>
              <td align="right">130.000</td>
              <td align="right">2.768</td>
              <td align="right">0.328</td>
              <td align="right">12.510</td>
            </tr>
            <tr>
              <td align="left">Ba</td>
              <td align="left">Forest</td>
              <td align="right">173.878</td>
              <td align="right">54.575</td>
              <td align="right">390.000</td>
              <td align="right">60.000</td>
              <td align="right">7.796</td>
              <td align="right">1.854</td>
              <td align="right">31.387</td>
            </tr>
            <tr>
              <td align="left">Be</td>
              <td align="left">Agriculture</td>
              <td align="right">0.959</td>
              <td align="right">0.081</td>
              <td align="right">1.130</td>
              <td align="right">0.750</td>
              <td align="right">0.012</td>
              <td align="right">0.009</td>
              <td align="right">8.423</td>
            </tr>
            <tr>
              <td align="left">Be</td>
              <td align="left">Forest</td>
              <td align="right">0.462</td>
              <td align="right">0.067</td>
              <td align="right">0.670</td>
              <td align="right">0.350</td>
              <td align="right">0.010</td>
              <td align="right">0.451</td>
              <td align="right">14.536</td>
            </tr>
            <tr>
              <td align="left">Bi</td>
              <td align="left">Agriculture</td>
              <td align="right">0.250</td>
              <td align="right">0.032</td>
              <td align="right">0.380</td>
              <td align="right">0.200</td>
              <td align="right">0.005</td>
              <td align="right">1.764</td>
              <td align="right">12.774</td>
            </tr>
            <tr>
              <td align="left">Bi</td>
              <td align="left">Forest</td>
              <td align="right">0.178</td>
              <td align="right">0.031</td>
              <td align="right">0.230</td>
              <td align="right">0.110</td>
              <td align="right">0.004</td>
              <td align="right">-0.484</td>
              <td align="right">17.444</td>
            </tr>
            <tr>
              <td align="left">Ca</td>
              <td align="left">Agriculture</td>
              <td align="right">4.001</td>
              <td align="right">2.187</td>
              <td align="right">8.780</td>
              <td align="right">0.950</td>
              <td align="right">0.312</td>
              <td align="right">0.277</td>
              <td align="right">54.664</td>
            </tr>
            <tr>
              <td align="left">Ca</td>
              <td align="left">Forest</td>
              <td align="right">1.887</td>
              <td align="right">1.530</td>
              <td align="right">5.460</td>
              <td align="right">0.470</td>
              <td align="right">0.219</td>
              <td align="right">1.067</td>
              <td align="right">81.120</td>
            </tr>
            <tr>
              <td align="left">Cd</td>
              <td align="left">Agriculture</td>
              <td align="right">0.592</td>
              <td align="right">0.057</td>
              <td align="right">0.720</td>
              <td align="right">0.480</td>
              <td align="right">0.008</td>
              <td align="right">-0.008</td>
              <td align="right">9.604</td>
            </tr>
            <tr>
              <td align="left">Cd</td>
              <td align="left">Forest</td>
              <td align="right">0.518</td>
              <td align="right">0.284</td>
              <td align="right">1.760</td>
              <td align="right">0.210</td>
              <td align="right">0.041</td>
              <td align="right">2.875</td>
              <td align="right">54.782</td>
            </tr>
            <tr>
              <td align="left">Ce</td>
              <td align="left">Agriculture</td>
              <td align="right">36.800</td>
              <td align="right">2.359</td>
              <td align="right">41.000</td>
              <td align="right">31.800</td>
              <td align="right">0.337</td>
              <td align="right">-0.244</td>
              <td align="right">6.411</td>
            </tr>
            <tr>
              <td align="left">Ce</td>
              <td align="left">Forest</td>
              <td align="right">31.190</td>
              <td align="right">5.532</td>
              <td align="right">46.800</td>
              <td align="right">21.400</td>
              <td align="right">0.790</td>
              <td align="right">0.524</td>
              <td align="right">17.736</td>
            </tr>
            <tr>
              <td align="left">Co</td>
              <td align="left">Agriculture</td>
              <td align="right">8.755</td>
              <td align="right">0.830</td>
              <td align="right">10.600</td>
              <td align="right">7.500</td>
              <td align="right">0.119</td>
              <td align="right">0.521</td>
              <td align="right">9.479</td>
            </tr>
            <tr>
              <td align="left">Co</td>
              <td align="left">Forest</td>
              <td align="right">6.757</td>
              <td align="right">1.393</td>
              <td align="right">9.600</td>
              <td align="right">4.000</td>
              <td align="right">0.199</td>
              <td align="right">0.030</td>
              <td align="right">20.622</td>
            </tr>
            <tr>
              <td align="left">Cr</td>
              <td align="left">Agriculture</td>
              <td align="right">23.388</td>
              <td align="right">1.935</td>
              <td align="right">26.000</td>
              <td align="right">17.000</td>
              <td align="right">0.276</td>
              <td align="right">-0.630</td>
              <td align="right">8.271</td>
            </tr>
            <tr>
              <td align="left">Cr</td>
              <td align="left">Forest</td>
              <td align="right">13.408</td>
              <td align="right">1.567</td>
              <td align="right">17.000</td>
              <td align="right">10.000</td>
              <td align="right">0.224</td>
              <td align="right">0.090</td>
              <td align="right">11.686</td>
            </tr>
            <tr>
              <td align="left">Cs</td>
              <td align="left">Agriculture</td>
              <td align="right">0.745</td>
              <td align="right">0.148</td>
              <td align="right">1.070</td>
              <td align="right">0.470</td>
              <td align="right">0.021</td>
              <td align="right">0.182</td>
              <td align="right">19.926</td>
            </tr>
            <tr>
              <td align="left">Cs</td>
              <td align="left">Forest</td>
              <td align="right">0.553</td>
              <td align="right">0.120</td>
              <td align="right">0.780</td>
              <td align="right">0.340</td>
              <td align="right">0.017</td>
              <td align="right">0.249</td>
              <td align="right">21.734</td>
            </tr>
            <tr>
              <td align="left">Cu</td>
              <td align="left">Agriculture</td>
              <td align="right">25.169</td>
              <td align="right">2.264</td>
              <td align="right">30.400</td>
              <td align="right">20.100</td>
              <td align="right">0.323</td>
              <td align="right">0.104</td>
              <td align="right">8.997</td>
            </tr>
            <tr>
              <td align="left">Cu</td>
              <td align="left">Forest</td>
              <td align="right">13.145</td>
              <td align="right">2.816</td>
              <td align="right">23.100</td>
              <td align="right">10.100</td>
              <td align="right">0.402</td>
              <td align="right">1.786</td>
              <td align="right">21.425</td>
            </tr>
            <tr>
              <td align="left">Fe</td>
              <td align="left">Agriculture</td>
              <td align="right">1.918</td>
              <td align="right">0.090</td>
              <td align="right">2.110</td>
              <td align="right">1.710</td>
              <td align="right">0.013</td>
              <td align="right">-0.255</td>
              <td align="right">4.702</td>
            </tr>
            <tr>
              <td align="left">Fe</td>
              <td align="left">Forest</td>
              <td align="right">1.182</td>
              <td align="right">0.133</td>
              <td align="right">1.460</td>
              <td align="right">0.830</td>
              <td align="right">0.019</td>
              <td align="right">-0.584</td>
              <td align="right">11.239</td>
            </tr>
            <tr>
              <td align="left">Ga</td>
              <td align="left">Agriculture</td>
              <td align="right">4.202</td>
              <td align="right">0.341</td>
              <td align="right">4.830</td>
              <td align="right">3.140</td>
              <td align="right">0.049</td>
              <td align="right">-0.594</td>
              <td align="right">8.120</td>
            </tr>
            <tr>
              <td align="left">Ga</td>
              <td align="left">Forest</td>
              <td align="right">2.209</td>
              <td align="right">0.277</td>
              <td align="right">2.770</td>
              <td align="right">1.650</td>
              <td align="right">0.040</td>
              <td align="right">0.097</td>
              <td align="right">12.533</td>
            </tr>
            <tr>
              <td align="left">Hf</td>
              <td align="left">Agriculture</td>
              <td align="right">0.154</td>
              <td align="right">0.038</td>
              <td align="right">0.220</td>
              <td align="right">0.080</td>
              <td align="right">0.005</td>
              <td align="right">-0.086</td>
              <td align="right">24.639</td>
            </tr>
            <tr>
              <td align="left">Hf</td>
              <td align="left">Forest</td>
              <td align="right">0.116</td>
              <td align="right">0.028</td>
              <td align="right">0.170</td>
              <td align="right">0.060</td>
              <td align="right">0.004</td>
              <td align="right">0.104</td>
              <td align="right">23.798</td>
            </tr>
            <tr>
              <td align="left">Hg</td>
              <td align="left">Agriculture</td>
              <td align="right">0.043</td>
              <td align="right">0.007</td>
              <td align="right">0.050</td>
              <td align="right">0.030</td>
              <td align="right">0.001</td>
              <td align="right">-0.459</td>
              <td align="right">16.499</td>
            </tr>
            <tr>
              <td align="left">Hg</td>
              <td align="left">Forest</td>
              <td align="right">0.056</td>
              <td align="right">0.018</td>
              <td align="right">0.100</td>
              <td align="right">0.030</td>
              <td align="right">0.003</td>
              <td align="right">0.379</td>
              <td align="right">32.290</td>
            </tr>
            <tr>
              <td align="left">In</td>
              <td align="left">Agriculture</td>
              <td align="right">0.031</td>
              <td align="right">0.003</td>
              <td align="right">0.036</td>
              <td align="right">0.023</td>
              <td align="right">0.000</td>
              <td align="right">-0.351</td>
              <td align="right">8.553</td>
            </tr>
            <tr>
              <td align="left">In</td>
              <td align="left">Forest</td>
              <td align="right">0.018</td>
              <td align="right">0.003</td>
              <td align="right">0.027</td>
              <td align="right">0.011</td>
              <td align="right">0.000</td>
              <td align="right">0.236</td>
              <td align="right">17.736</td>
            </tr>
            <tr>
              <td align="left">K</td>
              <td align="left">Agriculture</td>
              <td align="right">0.222</td>
              <td align="right">0.045</td>
              <td align="right">0.310</td>
              <td align="right">0.140</td>
              <td align="right">0.006</td>
              <td align="right">0.436</td>
              <td align="right">20.440</td>
            </tr>
            <tr>
              <td align="left">K</td>
              <td align="left">Forest</td>
              <td align="right">0.187</td>
              <td align="right">0.033</td>
              <td align="right">0.240</td>
              <td align="right">0.100</td>
              <td align="right">0.005</td>
              <td align="right">-0.294</td>
              <td align="right">17.849</td>
            </tr>
            <tr>
              <td align="left">La</td>
              <td align="left">Agriculture</td>
              <td align="right">18.231</td>
              <td align="right">1.223</td>
              <td align="right">20.200</td>
              <td align="right">15.500</td>
              <td align="right">0.175</td>
              <td align="right">-0.293</td>
              <td align="right">6.708</td>
            </tr>
            <tr>
              <td align="left">La</td>
              <td align="left">Forest</td>
              <td align="right">15.000</td>
              <td align="right">2.596</td>
              <td align="right">21.800</td>
              <td align="right">10.300</td>
              <td align="right">0.371</td>
              <td align="right">0.330</td>
              <td align="right">17.308</td>
            </tr>
            <tr>
              <td align="left">Li</td>
              <td align="left">Agriculture</td>
              <td align="right">15.622</td>
              <td align="right">1.423</td>
              <td align="right">19.800</td>
              <td align="right">12.800</td>
              <td align="right">0.203</td>
              <td align="right">0.618</td>
              <td align="right">9.108</td>
            </tr>
            <tr>
              <td align="left">Li</td>
              <td align="left">Forest</td>
              <td align="right">6.465</td>
              <td align="right">0.898</td>
              <td align="right">8.600</td>
              <td align="right">4.300</td>
              <td align="right">0.128</td>
              <td align="right">-0.022</td>
              <td align="right">13.887</td>
            </tr>
            <tr>
              <td align="left">Mg</td>
              <td align="left">Agriculture</td>
              <td align="right">0.765</td>
              <td align="right">0.097</td>
              <td align="right">0.970</td>
              <td align="right">0.520</td>
              <td align="right">0.014</td>
              <td align="right">-0.511</td>
              <td align="right">12.617</td>
            </tr>
            <tr>
              <td align="left">Mg</td>
              <td align="left">Forest</td>
              <td align="right">0.615</td>
              <td align="right">0.559</td>
              <td align="right">1.770</td>
              <td align="right">0.200</td>
              <td align="right">0.080</td>
              <td align="right">1.023</td>
              <td align="right">90.906</td>
            </tr>
            <tr>
              <td align="left">Mn</td>
              <td align="left">Agriculture</td>
              <td align="right">865.143</td>
              <td align="right">318.206</td>
              <td align="right">1800.000</td>
              <td align="right">468.000</td>
              <td align="right">45.458</td>
              <td align="right">0.940</td>
              <td align="right">36.781</td>
            </tr>
            <tr>
              <td align="left">Mn</td>
              <td align="left">Forest</td>
              <td align="right">996.367</td>
              <td align="right">313.072</td>
              <td align="right">2050.000</td>
              <td align="right">277.000</td>
              <td align="right">44.725</td>
              <td align="right">1.014</td>
              <td align="right">31.421</td>
            </tr>
            <tr>
              <td align="left">Mo</td>
              <td align="left">Agriculture</td>
              <td align="right">0.932</td>
              <td align="right">0.410</td>
              <td align="right">2.350</td>
              <td align="right">0.470</td>
              <td align="right">0.059</td>
              <td align="right">1.182</td>
              <td align="right">43.951</td>
            </tr>
            <tr>
              <td align="left">Mo</td>
              <td align="left">Forest</td>
              <td align="right">0.757</td>
              <td align="right">0.193</td>
              <td align="right">1.190</td>
              <td align="right">0.390</td>
              <td align="right">0.028</td>
              <td align="right">0.570</td>
              <td align="right">25.552</td>
            </tr>
            <tr>
              <td align="left">Nb</td>
              <td align="left">Agriculture</td>
              <td align="right">0.589</td>
              <td align="right">0.057</td>
              <td align="right">0.730</td>
              <td align="right">0.460</td>
              <td align="right">0.008</td>
              <td align="right">0.452</td>
              <td align="right">9.669</td>
            </tr>
            <tr>
              <td align="left">Nb</td>
              <td align="left">Forest</td>
              <td align="right">0.372</td>
              <td align="right">0.064</td>
              <td align="right">0.560</td>
              <td align="right">0.170</td>
              <td align="right">0.009</td>
              <td align="right">-0.677</td>
              <td align="right">17.103</td>
            </tr>
            <tr>
              <td align="left">Ni</td>
              <td align="left">Agriculture</td>
              <td align="right">29.627</td>
              <td align="right">2.716</td>
              <td align="right">35.700</td>
              <td align="right">25.000</td>
              <td align="right">0.388</td>
              <td align="right">0.356</td>
              <td align="right">9.169</td>
            </tr>
            <tr>
              <td align="left">Ni</td>
              <td align="left">Forest</td>
              <td align="right">18.092</td>
              <td align="right">3.898</td>
              <td align="right">28.000</td>
              <td align="right">11.000</td>
              <td align="right">0.557</td>
              <td align="right">0.328</td>
              <td align="right">21.548</td>
            </tr>
            <tr>
              <td align="left">P</td>
              <td align="left">Agriculture</td>
              <td align="right">701.429</td>
              <td align="right">72.342</td>
              <td align="right">860.000</td>
              <td align="right">560.000</td>
              <td align="right">10.335</td>
              <td align="right">0.154</td>
              <td align="right">10.313</td>
            </tr>
            <tr>
              <td align="left">P</td>
              <td align="left">Forest</td>
              <td align="right">749.184</td>
              <td align="right">117.948</td>
              <td align="right">990.000</td>
              <td align="right">520.000</td>
              <td align="right">16.850</td>
              <td align="right">0.053</td>
              <td align="right">15.744</td>
            </tr>
            <tr>
              <td align="left">Pb</td>
              <td align="left">Agriculture</td>
              <td align="right">11.702</td>
              <td align="right">0.798</td>
              <td align="right">13.200</td>
              <td align="right">9.900</td>
              <td align="right">0.114</td>
              <td align="right">-0.198</td>
              <td align="right">6.815</td>
            </tr>
            <tr>
              <td align="left">Pb</td>
              <td align="left">Forest</td>
              <td align="right">11.941</td>
              <td align="right">8.419</td>
              <td align="right">68.000</td>
              <td align="right">7.100</td>
              <td align="right">1.203</td>
              <td align="right">6.192</td>
              <td align="right">70.507</td>
            </tr>
            <tr>
              <td align="left">Rb</td>
              <td align="left">Agriculture</td>
              <td align="right">18.429</td>
              <td align="right">4.326</td>
              <td align="right">26.700</td>
              <td align="right">10.200</td>
              <td align="right">0.618</td>
              <td align="right">0.244</td>
              <td align="right">23.477</td>
            </tr>
            <tr>
              <td align="left">Rb</td>
              <td align="left">Forest</td>
              <td align="right">13.831</td>
              <td align="right">1.853</td>
              <td align="right">18.100</td>
              <td align="right">9.900</td>
              <td align="right">0.265</td>
              <td align="right">0.273</td>
              <td align="right">13.397</td>
            </tr>
            <tr>
              <td align="left">S</td>
              <td align="left">Agriculture</td>
              <td align="right">0.120</td>
              <td align="right">0.071</td>
              <td align="right">0.270</td>
              <td align="right">0.040</td>
              <td align="right">0.010</td>
              <td align="right">0.770</td>
              <td align="right">59.479</td>
            </tr>
            <tr>
              <td align="left">S</td>
              <td align="left">Forest</td>
              <td align="right">0.060</td>
              <td align="right">0.019</td>
              <td align="right">0.110</td>
              <td align="right">0.030</td>
              <td align="right">0.003</td>
              <td align="right">0.506</td>
              <td align="right">31.894</td>
            </tr>
            <tr>
              <td align="left">Sb</td>
              <td align="left">Agriculture</td>
              <td align="right">0.446</td>
              <td align="right">0.049</td>
              <td align="right">0.560</td>
              <td align="right">0.350</td>
              <td align="right">0.007</td>
              <td align="right">0.230</td>
              <td align="right">11.078</td>
            </tr>
            <tr>
              <td align="left">Sb</td>
              <td align="left">Forest</td>
              <td align="right">0.270</td>
              <td align="right">0.090</td>
              <td align="right">0.650</td>
              <td align="right">0.120</td>
              <td align="right">0.013</td>
              <td align="right">1.301</td>
              <td align="right">33.332</td>
            </tr>
            <tr>
              <td align="left">Sc</td>
              <td align="left">Agriculture</td>
              <td align="right">3.149</td>
              <td align="right">0.338</td>
              <td align="right">3.800</td>
              <td align="right">2.300</td>
              <td align="right">0.048</td>
              <td align="right">-0.256</td>
              <td align="right">10.732</td>
            </tr>
            <tr>
              <td align="left">Sc</td>
              <td align="left">Forest</td>
              <td align="right">1.624</td>
              <td align="right">0.237</td>
              <td align="right">2.000</td>
              <td align="right">1.000</td>
              <td align="right">0.034</td>
              <td align="right">-0.572</td>
              <td align="right">14.574</td>
            </tr>
            <tr>
              <td align="left">Se</td>
              <td align="left">Agriculture</td>
              <td align="right">1.616</td>
              <td align="right">0.535</td>
              <td align="right">2.700</td>
              <td align="right">0.700</td>
              <td align="right">0.076</td>
              <td align="right">0.182</td>
              <td align="right">33.085</td>
            </tr>
            <tr>
              <td align="left">Se</td>
              <td align="left">Forest</td>
              <td align="right">0.896</td>
              <td align="right">0.371</td>
              <td align="right">2.600</td>
              <td align="right">0.400</td>
              <td align="right">0.053</td>
              <td align="right">2.522</td>
              <td align="right">41.386</td>
            </tr>
            <tr>
              <td align="left">Sn</td>
              <td align="left">Agriculture</td>
              <td align="right">0.647</td>
              <td align="right">0.058</td>
              <td align="right">0.800</td>
              <td align="right">0.500</td>
              <td align="right">0.008</td>
              <td align="right">0.120</td>
              <td align="right">8.981</td>
            </tr>
            <tr>
              <td align="left">Sn</td>
              <td align="left">Forest</td>
              <td align="right">0.398</td>
              <td align="right">0.090</td>
              <td align="right">0.900</td>
              <td align="right">0.300</td>
              <td align="right">0.013</td>
              <td align="right">3.492</td>
              <td align="right">22.644</td>
            </tr>
            <tr>
              <td align="left">Sr</td>
              <td align="left">Agriculture</td>
              <td align="right">91.314</td>
              <td align="right">38.981</td>
              <td align="right">163.500</td>
              <td align="right">38.600</td>
              <td align="right">5.569</td>
              <td align="right">0.093</td>
              <td align="right">42.689</td>
            </tr>
            <tr>
              <td align="left">Sr</td>
              <td align="left">Forest</td>
              <td align="right">32.427</td>
              <td align="right">12.605</td>
              <td align="right">64.200</td>
              <td align="right">15.300</td>
              <td align="right">1.801</td>
              <td align="right">0.983</td>
              <td align="right">38.872</td>
            </tr>
            <tr>
              <td align="left">Te</td>
              <td align="left">Agriculture</td>
              <td align="right">0.046</td>
              <td align="right">0.008</td>
              <td align="right">0.070</td>
              <td align="right">0.030</td>
              <td align="right">0.001</td>
              <td align="right">0.402</td>
              <td align="right">17.736</td>
            </tr>
            <tr>
              <td align="left">Te</td>
              <td align="left">Forest</td>
              <td align="right">0.034</td>
              <td align="right">0.007</td>
              <td align="right">0.050</td>
              <td align="right">0.020</td>
              <td align="right">0.001</td>
              <td align="right">-0.022</td>
              <td align="right">21.598</td>
            </tr>
            <tr>
              <td align="left">Th</td>
              <td align="left">Agriculture</td>
              <td align="right">2.565</td>
              <td align="right">0.504</td>
              <td align="right">3.600</td>
              <td align="right">1.600</td>
              <td align="right">0.072</td>
              <td align="right">-0.084</td>
              <td align="right">19.629</td>
            </tr>
            <tr>
              <td align="left">Th</td>
              <td align="left">Forest</td>
              <td align="right">2.173</td>
              <td align="right">1.216</td>
              <td align="right">7.300</td>
              <td align="right">1.000</td>
              <td align="right">0.174</td>
              <td align="right">2.185</td>
              <td align="right">55.932</td>
            </tr>
            <tr>
              <td align="left">Tl</td>
              <td align="left">Agriculture</td>
              <td align="right">0.169</td>
              <td align="right">0.035</td>
              <td align="right">0.240</td>
              <td align="right">0.110</td>
              <td align="right">0.005</td>
              <td align="right">0.365</td>
              <td align="right">20.763</td>
            </tr>
            <tr>
              <td align="left">Tl</td>
              <td align="left">Forest</td>
              <td align="right">0.153</td>
              <td align="right">0.034</td>
              <td align="right">0.230</td>
              <td align="right">0.090</td>
              <td align="right">0.005</td>
              <td align="right">0.325</td>
              <td align="right">22.199</td>
            </tr>
            <tr>
              <td align="left">U</td>
              <td align="left">Agriculture</td>
              <td align="right">1.475</td>
              <td align="right">0.186</td>
              <td align="right">1.940</td>
              <td align="right">1.200</td>
              <td align="right">0.027</td>
              <td align="right">0.591</td>
              <td align="right">12.638</td>
            </tr>
            <tr>
              <td align="left">U</td>
              <td align="left">Forest</td>
              <td align="right">1.026</td>
              <td align="right">0.254</td>
              <td align="right">1.740</td>
              <td align="right">0.630</td>
              <td align="right">0.036</td>
              <td align="right">0.359</td>
              <td align="right">24.792</td>
            </tr>
            <tr>
              <td align="left">V</td>
              <td align="left">Agriculture</td>
              <td align="right">67.857</td>
              <td align="right">4.198</td>
              <td align="right">77.000</td>
              <td align="right">55.000</td>
              <td align="right">0.600</td>
              <td align="right">-0.363</td>
              <td align="right">6.187</td>
            </tr>
            <tr>
              <td align="left">V</td>
              <td align="left">Forest</td>
              <td align="right">34.122</td>
              <td align="right">4.910</td>
              <td align="right">44.000</td>
              <td align="right">25.000</td>
              <td align="right">0.701</td>
              <td align="right">0.269</td>
              <td align="right">14.390</td>
            </tr>
            <tr>
              <td align="left">Y</td>
              <td align="left">Agriculture</td>
              <td align="right">11.291</td>
              <td align="right">0.726</td>
              <td align="right">12.600</td>
              <td align="right">9.750</td>
              <td align="right">0.104</td>
              <td align="right">-0.427</td>
              <td align="right">6.431</td>
            </tr>
            <tr>
              <td align="left">Y</td>
              <td align="left">Forest</td>
              <td align="right">8.435</td>
              <td align="right">2.005</td>
              <td align="right">12.200</td>
              <td align="right">4.370</td>
              <td align="right">0.286</td>
              <td align="right">-0.348</td>
              <td align="right">23.766</td>
            </tr>
            <tr>
              <td align="left">Zn</td>
              <td align="left">Agriculture</td>
              <td align="right">93.796</td>
              <td align="right">7.681</td>
              <td align="right">106.000</td>
              <td align="right">75.000</td>
              <td align="right">1.097</td>
              <td align="right">-0.222</td>
              <td align="right">8.189</td>
            </tr>
            <tr>
              <td align="left">Zn</td>
              <td align="left">Forest</td>
              <td align="right">109.551</td>
              <td align="right">53.267</td>
              <td align="right">318.000</td>
              <td align="right">42.000</td>
              <td align="right">7.610</td>
              <td align="right">1.425</td>
              <td align="right">48.623</td>
            </tr>
            <tr>
              <td align="left">Zr</td>
              <td align="left">Agriculture</td>
              <td align="right">6.063</td>
              <td align="right">1.321</td>
              <td align="right">8.600</td>
              <td align="right">3.500</td>
              <td align="right">0.189</td>
              <td align="right">-0.103</td>
              <td align="right">21.781</td>
            </tr>
            <tr>
              <td align="left">Zr</td>
              <td align="left">Forest</td>
              <td align="right">4.135</td>
              <td align="right">0.916</td>
              <td align="right">7.200</td>
              <td align="right">2.300</td>
              <td align="right">0.131</td>
              <td align="right">1.123</td>
              <td align="right">22.164</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      </sec>
    </sec>
  </sec>
  <sec id="colour-nb-1">
    <title>Colour</title>
    <sec id="plot-prep-1-nb-1">
      <title>plot prep</title>
      <sec id="nb-code-cell-9-nb-1" specific-use="notebook-code">
      <code language="r script">colour &lt;- data2 %&gt;%
  filter(group == &quot;colour&quot;) %&gt;%
  mutate(element = str_extract(element, (&quot;[:alpha:](?=_)&quot;))) %&gt;% # remove _col
  mutate(bar = c(rep(c(rep(Inf, 2), rep(0, 2)), 7), Inf, Inf)) %&gt;%
  pivot_longer(cols = c(mean, max, min), names_to = &quot;variable&quot;) 

colour2 &lt;- data2 %&gt;%
  filter(group == &quot;colour&quot;) %&gt;%
  mutate(element = str_extract(element, (&quot;[:alpha:](?=_)&quot;))) %&gt;% # remove _col
  mutate(bar = c(rep(c(rep(Inf, 2), rep(0, 2)), 7), Inf, Inf))

colour3 &lt;- data2 %&gt;%
  filter(group == &quot;colour&quot;) %&gt;%
  mutate(element = str_extract(element, (&quot;[:alpha:](?=_)&quot;))) %&gt;% # remove _col
  mutate(bar = c(rep(c(rep(-Inf, 2), rep(0, 2)), 7), -Inf, -Inf))
      </code>
      </sec>
    </sec>
    <sec id="plot-1-nb-1">
      <title>plot</title>
      <sec id="nb-code-cell-10-nb-1" specific-use="notebook-code">
      <code language="r script">
p2 &lt;- ggplot() +
  theme_bw(base_size = 12) +
  geom_bar(data = colour2, aes(x=element, y = bar), fill =&quot;grey20&quot;, position=&quot;identity&quot;, stat = &quot;identity&quot;, alpha = 0.1) +
  geom_bar(data = colour3, aes(x=element, y = bar), fill =&quot;grey20&quot;, position=&quot;identity&quot;, stat = &quot;identity&quot;, alpha = 0.1) +
  geom_errorbar(data = colour2, aes(x = element, ymin = mean - sd, ymax = mean + sd, colour = site), width = .1, position = position_dodge(width = 0.5)) +
  geom_point(data = filter(colour, variable == &quot;mean&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 2) +
  geom_point(data = filter(colour, variable == &quot;max&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 2) +
  geom_point(data = filter(colour, variable == &quot;min&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 2) +
  geom_text(data = colour3, aes(x = element, y = spacer, colour = site, label = formatC(cv, digits = 1, format = &quot;f&quot;)), show.legend = FALSE, size = 4) +
  guides(color=guide_legend(override.aes=list(shape=NA))) +
  scale_shape_manual(values=c(3, 19, 4)) +
  scale_color_viridis_d(begin = 0.2, end = 0.7) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(legend.position = &quot;bottom&quot;,
        legend.title = element_blank()) +
  labs(y = &quot;Scaled value&quot;, x = &quot;Colour coefficient&quot;) 

#ggsave(plot = p2, filename = here::here(&quot;./images/colour_summary.png&quot;))
      </code>
      </sec>
    </sec>
  </sec>
  <sec id="plot2-1-nb-1">
    <title>Plot2</title>
    <sec id="nb-code-cell-11-nb-1" specific-use="notebook-code">
    <code language="r script">ggplot(data = filter(data, group == &quot;colour&quot;), aes(x = site, y = value, fill = site))+
  geom_boxplot() +
  theme_bw(base_size = 12) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7) +
  theme(legend.position = &quot;none&quot;,
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(x = &quot;Site&quot;, y = &quot;Value&quot;) +
  facet_wrap(~element, scales = &quot;free_y&quot;)
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="univariate_summary_files/figure-jats/unnamed-chunk-11-1.png" />
    </sec>
    <sec id="table-1-nb-1">
      <title>Table</title>
      <sec id="nb-code-cell-12-nb-1" specific-use="notebook-code">
      <code language="r script">colour_tab &lt;- data_summary %&gt;%
  filter(group == &quot;colour&quot;) %&gt;%
  mutate(element = str_extract(element, (&quot;[:alpha:](?=_)&quot;))) %&gt;% # remove _col
  select(-group) 

knitr::kable(colour_tab, digits = 3)
      </code>
      <table-wrap>
        <table>
          <colgroup>
            <col width="11%" />
            <col width="16%" />
            <col width="11%" />
            <col width="10%" />
            <col width="11%" />
            <col width="11%" />
            <col width="8%" />
            <col width="12%" />
            <col width="10%" />
          </colgroup>
          <thead>
            <tr>
              <th align="left">element</th>
              <th align="left">site</th>
              <th align="right">mean</th>
              <th align="right">sd</th>
              <th align="right">max</th>
              <th align="right">min</th>
              <th align="right">se</th>
              <th align="right">skewness</th>
              <th align="right">cv</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">B</td>
              <td align="left">Agriculture</td>
              <td align="right">108.713</td>
              <td align="right">7.138</td>
              <td align="right">124.075</td>
              <td align="right">90.820</td>
              <td align="right">1.020</td>
              <td align="right">-0.068</td>
              <td align="right">6.566</td>
            </tr>
            <tr>
              <td align="left">B</td>
              <td align="left">Forest</td>
              <td align="right">91.596</td>
              <td align="right">12.252</td>
              <td align="right">115.728</td>
              <td align="right">65.214</td>
              <td align="right">1.750</td>
              <td align="right">-0.026</td>
              <td align="right">13.376</td>
            </tr>
            <tr>
              <td align="left">G</td>
              <td align="left">Agriculture</td>
              <td align="right">121.574</td>
              <td align="right">7.814</td>
              <td align="right">138.629</td>
              <td align="right">101.553</td>
              <td align="right">1.116</td>
              <td align="right">0.085</td>
              <td align="right">6.427</td>
            </tr>
            <tr>
              <td align="left">G</td>
              <td align="left">Forest</td>
              <td align="right">108.599</td>
              <td align="right">15.617</td>
              <td align="right">139.062</td>
              <td align="right">76.917</td>
              <td align="right">2.231</td>
              <td align="right">0.043</td>
              <td align="right">14.380</td>
            </tr>
            <tr>
              <td align="left">L</td>
              <td align="left">Agriculture</td>
              <td align="right">51.993</td>
              <td align="right">3.097</td>
              <td align="right">58.684</td>
              <td align="right">43.914</td>
              <td align="right">0.442</td>
              <td align="right">0.066</td>
              <td align="right">5.956</td>
            </tr>
            <tr>
              <td align="left">L</td>
              <td align="left">Forest</td>
              <td align="right">47.451</td>
              <td align="right">6.346</td>
              <td align="right">59.480</td>
              <td align="right">34.342</td>
              <td align="right">0.907</td>
              <td align="right">-0.022</td>
              <td align="right">13.373</td>
            </tr>
            <tr>
              <td align="left">R</td>
              <td align="left">Agriculture</td>
              <td align="right">132.290</td>
              <td align="right">8.146</td>
              <td align="right">149.933</td>
              <td align="right">111.218</td>
              <td align="right">1.164</td>
              <td align="right">0.153</td>
              <td align="right">6.158</td>
            </tr>
            <tr>
              <td align="left">R</td>
              <td align="left">Forest</td>
              <td align="right">125.584</td>
              <td align="right">16.808</td>
              <td align="right">157.058</td>
              <td align="right">91.971</td>
              <td align="right">2.401</td>
              <td align="right">-0.014</td>
              <td align="right">13.384</td>
            </tr>
            <tr>
              <td align="left">X</td>
              <td align="left">Agriculture</td>
              <td align="right">23.306</td>
              <td align="right">3.162</td>
              <td align="right">30.618</td>
              <td align="right">15.890</td>
              <td align="right">0.452</td>
              <td align="right">0.357</td>
              <td align="right">13.567</td>
            </tr>
            <tr>
              <td align="left">X</td>
              <td align="left">Forest</td>
              <td align="right">19.909</td>
              <td align="right">5.772</td>
              <td align="right">32.219</td>
              <td align="right">9.801</td>
              <td align="right">0.825</td>
              <td align="right">0.295</td>
              <td align="right">28.993</td>
            </tr>
            <tr>
              <td align="left">Y</td>
              <td align="left">Agriculture</td>
              <td align="right">20.261</td>
              <td align="right">2.772</td>
              <td align="right">26.688</td>
              <td align="right">13.779</td>
              <td align="right">0.396</td>
              <td align="right">0.349</td>
              <td align="right">13.680</td>
            </tr>
            <tr>
              <td align="left">Y</td>
              <td align="left">Forest</td>
              <td align="right">16.846</td>
              <td align="right">4.963</td>
              <td align="right">27.550</td>
              <td align="right">8.173</td>
              <td align="right">0.709</td>
              <td align="right">0.315</td>
              <td align="right">29.458</td>
            </tr>
            <tr>
              <td align="left">Z</td>
              <td align="left">Agriculture</td>
              <td align="right">5.638</td>
              <td align="right">0.779</td>
              <td align="right">7.438</td>
              <td align="right">3.838</td>
              <td align="right">0.111</td>
              <td align="right">0.234</td>
              <td align="right">13.822</td>
            </tr>
            <tr>
              <td align="left">Z</td>
              <td align="left">Forest</td>
              <td align="right">4.113</td>
              <td align="right">1.148</td>
              <td align="right">6.640</td>
              <td align="right">2.007</td>
              <td align="right">0.164</td>
              <td align="right">0.284</td>
              <td align="right">27.910</td>
            </tr>
            <tr>
              <td align="left">a</td>
              <td align="left">Agriculture</td>
              <td align="right">3.383</td>
              <td align="right">0.322</td>
              <td align="right">4.152</td>
              <td align="right">2.586</td>
              <td align="right">0.046</td>
              <td align="right">-0.026</td>
              <td align="right">9.531</td>
            </tr>
            <tr>
              <td align="left">a</td>
              <td align="left">Forest</td>
              <td align="right">5.732</td>
              <td align="right">0.407</td>
              <td align="right">6.562</td>
              <td align="right">4.411</td>
              <td align="right">0.058</td>
              <td align="right">-0.378</td>
              <td align="right">7.095</td>
            </tr>
            <tr>
              <td align="left">b</td>
              <td align="left">Agriculture</td>
              <td align="right">8.842</td>
              <td align="right">0.973</td>
              <td align="right">10.587</td>
              <td align="right">6.689</td>
              <td align="right">0.139</td>
              <td align="right">-0.183</td>
              <td align="right">11.004</td>
            </tr>
            <tr>
              <td align="left">b</td>
              <td align="left">Forest</td>
              <td align="right">12.469</td>
              <td align="right">2.009</td>
              <td align="right">15.909</td>
              <td align="right">8.016</td>
              <td align="right">0.287</td>
              <td align="right">0.221</td>
              <td align="right">16.109</td>
            </tr>
            <tr>
              <td align="left">c</td>
              <td align="left">Agriculture</td>
              <td align="right">9.468</td>
              <td align="right">1.017</td>
              <td align="right">11.324</td>
              <td align="right">7.172</td>
              <td align="right">0.145</td>
              <td align="right">-0.189</td>
              <td align="right">10.741</td>
            </tr>
            <tr>
              <td align="left">c</td>
              <td align="left">Forest</td>
              <td align="right">13.739</td>
              <td align="right">1.943</td>
              <td align="right">16.998</td>
              <td align="right">9.149</td>
              <td align="right">0.278</td>
              <td align="right">0.149</td>
              <td align="right">14.145</td>
            </tr>
            <tr>
              <td align="left">h</td>
              <td align="left">Agriculture</td>
              <td align="right">1.205</td>
              <td align="right">0.013</td>
              <td align="right">1.234</td>
              <td align="right">1.180</td>
              <td align="right">0.002</td>
              <td align="right">0.185</td>
              <td align="right">1.116</td>
            </tr>
            <tr>
              <td align="left">h</td>
              <td align="left">Forest</td>
              <td align="right">1.134</td>
              <td align="right">0.047</td>
              <td align="right">1.225</td>
              <td align="right">1.056</td>
              <td align="right">0.007</td>
              <td align="right">0.342</td>
              <td align="right">4.130</td>
            </tr>
            <tr>
              <td align="left">u</td>
              <td align="left">Agriculture</td>
              <td align="right">8.075</td>
              <td align="right">0.816</td>
              <td align="right">9.774</td>
              <td align="right">6.202</td>
              <td align="right">0.117</td>
              <td align="right">-0.137</td>
              <td align="right">10.101</td>
            </tr>
            <tr>
              <td align="left">u</td>
              <td align="left">Forest</td>
              <td align="right">12.749</td>
              <td align="right">1.379</td>
              <td align="right">14.839</td>
              <td align="right">8.750</td>
              <td align="right">0.197</td>
              <td align="right">-0.298</td>
              <td align="right">10.812</td>
            </tr>
            <tr>
              <td align="left">v</td>
              <td align="left">Agriculture</td>
              <td align="right">3.803</td>
              <td align="right">0.438</td>
              <td align="right">4.659</td>
              <td align="right">2.956</td>
              <td align="right">0.063</td>
              <td align="right">-0.065</td>
              <td align="right">11.529</td>
            </tr>
            <tr>
              <td align="left">v</td>
              <td align="left">Forest</td>
              <td align="right">4.788</td>
              <td align="right">1.041</td>
              <td align="right">6.620</td>
              <td align="right">2.772</td>
              <td align="right">0.149</td>
              <td align="right">0.307</td>
              <td align="right">21.739</td>
            </tr>
            <tr>
              <td align="left">x</td>
              <td align="left">Agriculture</td>
              <td align="right">0.474</td>
              <td align="right">0.002</td>
              <td align="right">0.479</td>
              <td align="right">0.468</td>
              <td align="right">0.000</td>
              <td align="right">0.064</td>
              <td align="right">0.462</td>
            </tr>
            <tr>
              <td align="left">x</td>
              <td align="left">Forest</td>
              <td align="right">0.487</td>
              <td align="right">0.002</td>
              <td align="right">0.492</td>
              <td align="right">0.482</td>
              <td align="right">0.000</td>
              <td align="right">-0.208</td>
              <td align="right">0.466</td>
            </tr>
            <tr>
              <td align="left">y</td>
              <td align="left">Agriculture</td>
              <td align="right">0.412</td>
              <td align="right">0.001</td>
              <td align="right">0.413</td>
              <td align="right">0.410</td>
              <td align="right">0.000</td>
              <td align="right">-0.291</td>
              <td align="right">0.146</td>
            </tr>
            <tr>
              <td align="left">y</td>
              <td align="left">Forest</td>
              <td align="right">0.412</td>
              <td align="right">0.002</td>
              <td align="right">0.415</td>
              <td align="right">0.409</td>
              <td align="right">0.000</td>
              <td align="right">0.416</td>
              <td align="right">0.424</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      </sec>
    </sec>
  </sec>
  <sec id="psa-and-organic-matter-nb-1">
    <title>PSA and organic matter</title>
    <sec id="plot-prep-2-nb-1">
      <title>plot prep</title>
      <sec id="nb-code-cell-13-nb-1" specific-use="notebook-code">
      <code language="r script">psa &lt;- data2 %&gt;%
  filter(group %in% c(&quot;psa&quot;, &quot;organic&quot;)) %&gt;%
  mutate(bar = c(rep(c(rep(Inf, 2), rep(0, 2)), 1), Inf, Inf)) %&gt;%
  pivot_longer(cols = c(mean, max, min), names_to = &quot;variable&quot;) 

psa2 &lt;- data2 %&gt;%
  filter(group %in% c(&quot;psa&quot;, &quot;organic&quot;)) %&gt;%
  mutate(bar = c(rep(c(rep(Inf, 2), rep(0, 2)), 1), Inf, Inf)) 

psa3 &lt;- data2 %&gt;%
  filter(group %in% c(&quot;psa&quot;, &quot;organic&quot;)) %&gt;%
  mutate(bar = c(rep(c(rep(-Inf, 2), rep(0, 2)), 1), -Inf, -Inf))
      </code>
      </sec>
    </sec>
    <sec id="plot-2-nb-1">
      <title>plot</title>
      <sec id="nb-code-cell-14-nb-1" specific-use="notebook-code">
      <code language="r script">ggplot() +
  theme_bw(base_size = 12) +
  geom_bar(data = psa2, aes(x=element, y = bar), fill =&quot;grey20&quot;, position=&quot;identity&quot;, stat = &quot;identity&quot;, alpha = 0.1) +
  geom_bar(data = psa3, aes(x=element, y = bar), fill =&quot;grey20&quot;, position=&quot;identity&quot;, stat = &quot;identity&quot;, alpha = 0.1) +
  geom_errorbar(data = psa2, aes(x = element, ymin = mean - sd, ymax = mean + sd, colour = site), width = .2, position = position_dodge(width = 0.5)) +
  geom_point(data = filter(psa, variable == &quot;mean&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 2) +
  geom_point(data = filter(psa, variable == &quot;max&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 2) +
  geom_point(data = filter(psa, variable == &quot;min&quot;), aes(x = element, y = value, colour = site, shape = variable), position = position_dodge(width = 0.5), show.legend = TRUE, size = 2) +
  geom_text(data = psa3, aes(x = element, y = spacer, colour = site, label = formatC(cv, digits = 1, format = &quot;f&quot;)), show.legend = FALSE, size = 5) +
  guides(color=guide_legend(override.aes=list(shape=NA))) +
  scale_shape_manual(values=c(3, 19, 4)) +
  scale_color_viridis_d(begin = 0.2, end = 0.7) +
  scale_y_continuous(breaks = seq(0, 1, 0.2)) +
  theme(legend.position = &quot;bottom&quot;,
        legend.title = element_blank()) +
  labs(y = &quot;Scaled value&quot;, x = &quot;Soil property&quot;) 
      </code>
      <graphic mimetype="image" mime-subtype="png" xlink:href="univariate_summary_files/figure-jats/unnamed-chunk-14-1.png" />
      </sec>
    </sec>
  </sec>
  <sec id="plot2-2-nb-1">
    <title>Plot2</title>
    <sec id="nb-code-cell-15-nb-1" specific-use="notebook-code">
    <code language="r script">ggplot(data = filter(data, group %in% c(&quot;psa&quot;, &quot;organic&quot;)), aes(x = site, y = value, fill = site))+
  geom_boxplot() +
  theme_bw(base_size = 12) +
  scale_fill_viridis_d(begin = 0.2, end = 0.7) +
  theme(legend.position = &quot;none&quot;,
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(x = &quot;Site&quot;, y = &quot;Value&quot;) +
  facet_wrap(~element, scales = &quot;free_y&quot;)
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="univariate_summary_files/figure-jats/unnamed-chunk-15-1.png" />
    </sec>
    <sec id="table-2-nb-1">
      <title>Table</title>
      <sec id="nb-code-cell-16-nb-1" specific-use="notebook-code">
      <code language="r script">psa_tab &lt;- data_summary %&gt;%
  filter(group %in% c(&quot;psa&quot;, &quot;organic&quot;)) %&gt;%
  select(-group) 

knitr::kable(psa_tab, digits = 3)
      </code>
      <table-wrap>
        <table>
          <colgroup>
            <col width="10%" />
            <col width="15%" />
            <col width="12%" />
            <col width="10%" />
            <col width="12%" />
            <col width="12%" />
            <col width="9%" />
            <col width="12%" />
            <col width="9%" />
          </colgroup>
          <thead>
            <tr>
              <th align="left">element</th>
              <th align="left">site</th>
              <th align="right">mean</th>
              <th align="right">sd</th>
              <th align="right">max</th>
              <th align="right">min</th>
              <th align="right">se</th>
              <th align="right">skewness</th>
              <th align="right">cv</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">dx_50</td>
              <td align="left">Agriculture</td>
              <td align="right">5.437</td>
              <td align="right">0.484</td>
              <td align="right">7.305</td>
              <td align="right">4.638</td>
              <td align="right">0.069</td>
              <td align="right">1.177</td>
              <td align="right">8.908</td>
            </tr>
            <tr>
              <td align="left">dx_50</td>
              <td align="left">Forest</td>
              <td align="right">16.747</td>
              <td align="right">5.030</td>
              <td align="right">28.992</td>
              <td align="right">8.492</td>
              <td align="right">0.711</td>
              <td align="right">0.662</td>
              <td align="right">30.034</td>
            </tr>
            <tr>
              <td align="left">organic</td>
              <td align="left">Agriculture</td>
              <td align="right">8.508</td>
              <td align="right">1.373</td>
              <td align="right">11.363</td>
              <td align="right">5.863</td>
              <td align="right">0.196</td>
              <td align="right">0.068</td>
              <td align="right">16.132</td>
            </tr>
            <tr>
              <td align="left">organic</td>
              <td align="left">Forest</td>
              <td align="right">11.551</td>
              <td align="right">5.993</td>
              <td align="right">26.987</td>
              <td align="right">1.373</td>
              <td align="right">0.856</td>
              <td align="right">0.372</td>
              <td align="right">51.886</td>
            </tr>
            <tr>
              <td align="left">ssa</td>
              <td align="left">Agriculture</td>
              <td align="right">1853.021</td>
              <td align="right">187.324</td>
              <td align="right">2195.720</td>
              <td align="right">1458.533</td>
              <td align="right">26.761</td>
              <td align="right">0.000</td>
              <td align="right">10.109</td>
            </tr>
            <tr>
              <td align="left">ssa</td>
              <td align="left">Forest</td>
              <td align="right">763.475</td>
              <td align="right">133.484</td>
              <td align="right">1032.611</td>
              <td align="right">492.593</td>
              <td align="right">18.878</td>
              <td align="right">-0.084</td>
              <td align="right">17.484</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      </sec>
      <sec id="nb-code-cell-17-nb-1" specific-use="notebook-code">
      <code language="r script">summary_tab &lt;- data_summary %&gt;%
  filter(site == &quot;Forest&quot;&amp; element %in% c(&quot;h_col&quot;, &quot;L_col&quot;, &quot;v_col&quot;, &quot;Li&quot;, &quot;Nb&quot;, &quot;Zn&quot;, &quot;ssa&quot;, &quot;organic&quot;) | site == &quot;Agriculture&quot; &amp; element %in% c(&quot;a_col&quot;, &quot;c_col&quot;, &quot;h_col&quot;, &quot;Ca&quot;, &quot;Mo&quot;, &quot;U&quot;, &quot;ssa&quot;, &quot;organic&quot;)) %&gt;%
  mutate(element = fct_relevel(element, c(&quot;Li&quot;, &quot;Nb&quot;, &quot;Zn&quot;,&quot;Ca&quot;, &quot;Mo&quot;, &quot;U&quot;, &quot;a_col&quot;, &quot;c_col&quot;,&quot;h_col&quot;, &quot;L_col&quot;, &quot;v_col&quot;, &quot;ssa&quot;, &quot;organic&quot;))) %&gt;%
  arrange(element) %&gt;%
  mutate(element = as.character(fct_recode(element, &quot;*h**&quot; = &quot;h_col&quot;, &quot;*a**&quot; = &quot;a_col&quot;, &quot;*c**&quot; = &quot;c_col&quot;, &quot;*L*&quot; = &quot;L_col&quot;, &quot;*v**&quot; = &quot;v_col&quot;, &quot;SSA&quot; = &quot;ssa&quot;, &quot;Org&quot; = &quot;organic&quot;))) %&gt;%
  rename(&quot;Element&quot; = &quot;element&quot;, &quot;Mean&quot; = &quot;mean&quot;, &quot;SD&quot; = &quot;sd&quot;, &quot;Max&quot; = &quot;max&quot;, &quot;Min&quot; = &quot;min&quot;, &quot;Skewness&quot; = &quot;skewness&quot;, &quot;CV&quot; = &quot;cv&quot;)
      </code>
      </sec>
      <sec id="nb-code-cell-18-nb-1" specific-use="notebook-code">
      <code language="r script">
summary_tab |&gt;
  group_by(site) |&gt;
  select(-group, -se) |&gt;
  gt() |&gt;
  fmt_markdown(columns = Element)|&gt;
  fmt_number(decimals = 2) |&gt;
  #cols_align(align = &quot;left&quot;) |&gt;
  tab_style(style =  cell_text(weight = &quot;bold&quot;, align = &quot;center&quot;), locations =  cells_row_groups()) |&gt;
  tab_options(column_labels.font.weight = &quot;bold&quot;)
      </code>
      <fig id="tbl-univariate-summary-nb-1">
        <caption><p>Summary statistics for for six examples of for six
        examples of geochemical and colour soil properties, specific
        surface area, and organic matter content for each
        site.</p></caption>
      </fig>
      </sec>
      <sec id="nb-code-cell-19-nb-1" specific-use="notebook-code">
      <code language="r script">forest_data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10))) %&gt;% ##Resolution from 1m by 1m to 10m by 10m
  pivot_longer(cols = elevation:vertical_distance_channel_network, names_to = &quot;property&quot;, values_to = &quot;value&quot;) %&gt;%
  group_by(property) %&gt;%
  summarise(Mean = mean(value, na.rm = T),
            SD = sd(value, na.rm = T),
            Max = max(value, na.rm = T),
            Min = min(value, na.rm = T),
            #Se = sd(value)/ sqrt(length(value)),
            Skewness = moments::skewness(value, na.rm = TRUE),
            CV = sd(value, na.rm = TRUE) / mean(value, na.rm = TRUE) * 100, .groups = &quot;drop&quot;) %&gt;%
  mutate(site = &quot;Forest&quot;)

ag_data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10))) %&gt;% ##Resolution from 1m by 1m to 10m by 10m
  pivot_longer(cols = elevation:vertical_distance_channel_network, names_to = &quot;property&quot;, values_to = &quot;value&quot;) %&gt;%
  group_by(property) %&gt;%
  summarise(Mean = mean(value, na.rm = T),
            SD = sd(value, na.rm = T),
            Max = max(value, na.rm = T),
            Min = min(value, na.rm = T),
            #Se = sd(value)/ sqrt(length(value)),
            Skewness = moments::skewness(value, na.rm = TRUE),
            CV = sd(value, na.rm = TRUE) / mean(value, na.rm = TRUE) * 100, .groups = &quot;drop&quot;) %&gt;%
  mutate(site = &quot;Agriculture&quot;)

terrain_summary &lt;- forest_data %&gt;%
  bind_rows(ag_data) %&gt;%
  mutate(property = fct_relevel(property, c(&quot;li&quot;, &quot;nb&quot;, &quot;zn&quot;,&quot;ca&quot;, &quot;mo&quot;, &quot;u&quot;, &quot;a_col&quot;, &quot;c_col&quot;,&quot;h_col&quot;, &quot;l_col&quot;, &quot;v_col&quot;, &quot;ssa&quot;, &quot;organic&quot;, &quot;elevation&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;profile_curvature&quot;, &quot;plan_curvature&quot;))) %&gt;%
  arrange(property) %&gt;%
  mutate(property = as.character(fct_recode(property, &quot;*h**&quot; = &quot;h_col&quot;, &quot;*a**&quot; = &quot;a_col&quot;, &quot;*c**&quot; = &quot;c_col&quot;, &quot;*L*&quot; = &quot;l_col&quot;, &quot;*v**&quot; = &quot;v_col&quot;, &quot;SSA&quot; = &quot;ssa&quot;, &quot;Org&quot; = &quot;organic&quot;, &quot;Li&quot; = &quot;li&quot;, &quot;Nb&quot; = &quot;nb&quot;, &quot;Zn&quot; = &quot;zn&quot;, &quot;Ca&quot; = &quot;ca&quot;, &quot;Mo&quot; = &quot;mo&quot;, &quot;U&quot; = &quot;u&quot;, &quot;Elevation&quot; = &quot;elevation&quot;, &quot;Catchment Area&quot; = &quot;catchment_area&quot;, &quot;Plan Curvature&quot; = &quot;plan_curvature&quot;, &quot;Profile Curvature&quot; = &quot;profile_curvature&quot;, &quot;Rel. Slope Position&quot; = &quot;relative_slope_position&quot;, &quot;SAGA Wetness Index&quot; = &quot;saga_wetness_index&quot;, &quot;Vert. Dist. Channel&quot; = &quot;vertical_distance_channel_network&quot;)))
      </code>
      </sec>
      <sec id="nb-code-cell-20-nb-1" specific-use="notebook-code">
      <code language="r script">
terrain_summary |&gt;
  rename(&quot;Property&quot; = &quot;property&quot;) |&gt;
  group_by(site) |&gt;
  select(-site) |&gt;
  gt() |&gt;
  fmt_markdown(columns = Property)|&gt;
  fmt_number(decimals = 2) |&gt;
  #cols_align(align = &quot;left&quot;) |&gt;
  tab_style(style =  cell_text(weight = &quot;bold&quot;, align = &quot;center&quot;), locations =  cells_row_groups()) |&gt;
  tab_options(column_labels.font.weight = &quot;bold&quot;)
      </code>
      <fig id="tbl-univariate2-summary-nb-1">
        <caption><p>Summary statistics for the interpoloated values (10m
        resolution) for six examples of geochemical and colour soil
        properties, specific surface area, organic matter content, and
        seven terrain attributes for each site.</p></caption>
      </fig>
      <sec id="nb-code-cell-20-output-0-nb-1" specific-use="notebook-output">
      <preformat>Adding missing grouping variables: `site`</preformat>
      </sec>
      </sec>
      <sec id="nb-code-cell-21-nb-1" specific-use="notebook-code">
      <code language="r script">temp &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
summary(temp)
      </code>
      <sec id="nb-code-cell-21-output-0-nb-1" specific-use="notebook-output">
      <preformat>       x                y             elevation           li       
 Min.   :460125   Min.   :5619241   Min.   :358.3   Min.   :4.340  
 1st Qu.:460296   1st Qu.:5619402   1st Qu.:367.1   1st Qu.:5.970  
 Median :460468   Median :5619563   Median :369.1   Median :6.473  
 Mean   :460468   Mean   :5619563   Mean   :369.3   Mean   :6.438  
 3rd Qu.:460640   3rd Qu.:5619725   3rd Qu.:371.7   3rd Qu.:6.924  
 Max.   :460811   Max.   :5619886   Max.   :377.2   Max.   :8.566  
                                                                   
       nb               zn             v_col           l_col      
 Min.   :0.2863   Min.   : 42.15   Min.   :2.775   Min.   :34.38  
 1st Qu.:0.3532   1st Qu.: 78.33   1st Qu.:4.217   1st Qu.:43.74  
 Median :0.3707   Median :105.71   Median :4.670   Median :46.70  
 Mean   :0.3712   Mean   :111.46   Mean   :4.778   Mean   :47.25  
 3rd Qu.:0.3946   3rd Qu.:133.28   3rd Qu.:5.340   3rd Qu.:51.08  
 Max.   :0.4345   Max.   :317.76   Max.   :6.616   Max.   :59.48  
                                   NA's   :646     NA's   :646    
     h_col          organic            ssa         plan_curvature      
 Min.   :1.056   Min.   : 7.370   Min.   : 483.7   Min.   :-0.2613780  
 1st Qu.:1.101   1st Qu.: 9.948   1st Qu.: 673.1   1st Qu.:-0.0047240  
 Median :1.129   Median :11.713   Median : 765.6   Median : 0.0002220  
 Mean   :1.134   Mean   :11.532   Mean   : 760.4   Mean   : 0.0003896  
 3rd Qu.:1.164   3rd Qu.:13.093   3rd Qu.: 841.8   3rd Qu.: 0.0054000  
 Max.   :1.226   Max.   :16.127   Max.   :1102.9   Max.   : 0.3002240  
 NA's   :646                      NA's   :646                          
 profile_curvature    saga_wetness_index catchment_area     
 Min.   :-0.4671840   Min.   :0.08561    Min.   :     0.67  
 1st Qu.:-0.0056550   1st Qu.:5.35456    1st Qu.:     2.15  
 Median :-0.0000170   Median :6.16257    Median :     6.39  
 Mean   :-0.0002214   Mean   :6.00142    Mean   :   565.06  
 3rd Qu.: 0.0059800   3rd Qu.:6.84742    3rd Qu.:    33.44  
 Max.   : 0.4505650   Max.   :9.95577    Max.   :209263.22  
                                                            
 relative_slope_position vertical_distance_channel_network
 Min.   :-0.11710        Min.   :-0.6669                  
 1st Qu.: 0.04232        1st Qu.: 0.1102                  
 Median : 0.11316        Median : 0.2677                  
 Mean   : 0.22326        Mean   : 0.4665                  
 3rd Qu.: 0.30031        3rd Qu.: 0.6018                  
 Max.   : 1.00000        Max.   : 4.9035                  
                                                          </preformat>
      </sec>
      </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-2-nb-2">
<front-stub>
<title-group>
<article-title>v* (opponent blue–yellow scales) Forest site
RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-2">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-2" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-2">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-2" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;)) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;v_col&quot;, any_of(attribute))
  </code>
  <sec id="nb-code-cell-2-output-0-nb-2" specific-use="notebook-output">
  <preformat>Rows: 443802 Columns: 17
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
dbl (17): x, y, elevation, li, nb, zn, v_col, l_col, h_col, organic, ssa, pl...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
  </sec>
  </sec>
</sec>
<sec id="map-soil-property-nb-2">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-2" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = v_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;v*&quot;)), breaks = seq(2, 7, 1)) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-2" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="v_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-2">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-2" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-2">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-2" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-2">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-2" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -v_col), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-2" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-2" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( vertical_distance_channel_network ~ catchment_area ):  -0.0008397144 
max correlation ( vertical_distance_channel_network ~ saga_wetness_index ):  -0.6528616 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 2.617416
2                    plan_curvature 1.058396
3                 profile_curvature 1.713930
4                saga_wetness_index 1.860201
5                    catchment_area 1.551615
6           relative_slope_position 2.898799
7 vertical_distance_channel_network 2.788326</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-2">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-2" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-2" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-2" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-2" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-2">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-2" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(v_col ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="v_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-2" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-2">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-2" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(v_col ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$v_col,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -v_col))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-2" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = v_col ~ ., data = select(filter(train,      dataset == &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE,      importance = TRUE, mtry = my_mtry, ytest = select(filter(train,          dataset == &quot;validation&quot;), -dataset)$v_col, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -v_col)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.2094445
                    % Var explained: 59.98
                       Test set MSE: 0.2
                    % Var explained: 62.73</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-2" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="v_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-2">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-2" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$v_col)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="v_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-2" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.19331 -0.20825 -0.01709  0.21596  1.21133 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  2.08552    0.07138   29.22   &lt;2e-16 ***
obs          0.56177    0.01478   38.02   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3197 on 882 degrees of freedom
Multiple R-squared:  0.621, Adjusted R-squared:  0.6206 
F-statistic:  1445 on 1 and 882 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-2" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-2" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-2">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-2" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-2">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-2" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-2" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 184.78848     464.75861                         elevation
7  49.35386     196.06006 vertical_distance_channel_network
6 109.57221     194.25561           relative_slope_position
4  37.83475     170.55346                saga_wetness_index
5  51.35181     143.87974                    catchment_area
3  38.58106     135.11049                 profile_curvature
2  25.48502      79.24105                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-2" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-2">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-2" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-2" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 184.78848     464.75861                         elevation
6 109.57221     194.25561           relative_slope_position
5  51.35181     143.87974                    catchment_area
7  49.35386     196.06006 vertical_distance_channel_network
3  38.58106     135.11049                 profile_curvature
4  37.83475     170.55346                saga_wetness_index
2  25.48502      79.24105                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-2" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-2">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-2" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="v_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-2">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-2" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Forest&quot;,
        property = &quot;v_col&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-2" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-3-nb-3">
<front-stub>
<title-group>
<article-title>Random Forest results</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-3">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-3" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(patchwork)
})
  </code>
  </sec>
  <sec id="nb-code-cell-2-nb-3" specific-use="notebook-code">
  <code language="r script">imp_data &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) %&gt;%
  rename(&quot;Terrain Attribute&quot; = &quot;Var.Names&quot;) %&gt;%
  mutate(`Terrain Attribute` = fct_recode(`Terrain Attribute`, &quot;Elevation&quot; = &quot;elevation&quot;, 
                                          &quot;Catchment Area&quot; = &quot;catchment_area&quot;,
                                          &quot;Plan Curvature&quot; = &quot;plan_curvature&quot;,
                                          &quot;Profile Curvature&quot; = &quot;profile_curvature&quot;,
                                          &quot;Rel. Slope Position&quot; = &quot;relative_slope_position&quot;,
                                          &quot;SAGA Wetness Index&quot; = &quot;saga_wetness_index&quot;,
                                          &quot;Vert. Dist. Channel&quot; = &quot;vertical_distance_channel_network&quot;)) %&gt;%
  mutate(`Terrain Attribute` = fct_relevel(`Terrain Attribute`, &quot;Elevation&quot;, &quot;Rel. Slope Position&quot;, &quot;Vert. Dist. Channel&quot;, &quot;SAGA Wetness Index&quot;, &quot;Catchment Area&quot;, &quot;Profile Curvature&quot;, &quot;Plan Curvature&quot;)) %&gt;%
  mutate(property = fct_recode(property, &quot;italic(`a*`)&quot; = &quot;a_col&quot;, &quot;italic(`c*`)&quot; = &quot;c_col&quot;, &quot;italic(`h*`)&quot; = &quot;h_col&quot;, 
    &quot;italic(`L`)&quot; = &quot;l_col&quot;,  &quot;italic(`v*`)&quot; = &quot;v_col&quot;)) %&gt;%
  mutate(property = fct_relevel(property, &quot;Ca&quot;, &quot;Li&quot;, &quot;Mo&quot;, &quot;Nb&quot;, &quot;U&quot;, &quot;Zn&quot;, &quot;italic(`a*`)&quot;, &quot;italic(`c*`)&quot;,  &quot;italic(`L`)&quot;, &quot;italic(`v*`)&quot;))
  </code>
  <code language="r script">avg &lt;- imp_data %&gt;%
  group_by(`Terrain Attribute`) %&gt;%
  summarise(total = mean(MSE_rank)) %&gt;%
  arrange(total) |&gt;
  mutate(MSE_rank = 1:n(),
         property = &quot;Overall&quot;)

avg_site&lt;- imp_data %&gt;%
  group_by(`Terrain Attribute`, site) %&gt;%
  summarise(total = mean(MSE_rank)) %&gt;%
  group_by(site) %&gt;%
  arrange(total) |&gt;
  mutate(MSE_rank = 1:n(),
         property = site)
  </code>
  <code language="r script">overall &lt;- avg_site %&gt;%
  bind_rows(avg) %&gt;%
  mutate(facet = &quot;Average&quot;) %&gt;%
  mutate(`Terrain Attribute` = fct_relevel(`Terrain Attribute`, &quot;Elevation&quot;, &quot;Rel. Slope Position&quot;, &quot;Vert. Dist. Channel&quot;, &quot;SAGA Wetness Index&quot;, &quot;Catchment Area&quot;, &quot;Profile Curvature&quot;, &quot;Plan Curvature&quot;))

g1 &lt;- ggplot(data = imp_data, aes(x = as.factor(MSE_rank), y = property, fill = `Terrain Attribute`)) + 
  geom_tile() +
  theme_bw() +
  viridis::scale_fill_viridis(discrete = TRUE) +
  theme(axis.title.y = element_blank()) +
  labs(x = &quot;Importance Ranking \n(% Increase in Mean Squared Error)&quot;) +
  scale_y_discrete(labels = scales::label_parse(), limits=rev, expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  facet_wrap(~site, ncol = 1, scales = &quot;free_y&quot;, strip.position = &quot;right&quot;)

g2 &lt;- ggplot(data = overall, aes(x = as.factor(MSE_rank), y = property, fill = `Terrain Attribute`)) + 
  geom_tile() +
  theme_bw() +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_discrete(expand = c(0,0)) +
  viridis::scale_fill_viridis(discrete = TRUE) +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank(),
        axis.title.y = element_blank())  +
  facet_wrap(~facet, ncol = 1, scales = &quot;free_y&quot;, strip.position = &quot;right&quot;)
  </code>
  <sec id="nb-code-cell-2-output-0-nb-3" specific-use="notebook-output">
  <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
  </sec>
  <sec id="nb-code-cell-2-output-1-nb-3" specific-use="notebook-output">
  <preformat>`summarise()` has grouped output by 'Terrain Attribute'. You can override using
the `.groups` argument.</preformat>
  </sec>
  </sec>
  <sec id="cell-fig-RF-results-nb-3" specific-use="notebook-code">
  <code language="r script">
g2 + g1 + plot_layout(ncol = 1, heights = c(2, 10), guides = &quot;collect&quot;) &amp; theme(legend.position = 'right')
  </code>
  <fig id="fig-RF-results-nb-3">
    <caption><p>Heat map of the Random Forest regresssion results
    showing the ranking of the importance of terrain attributes (based
    on % increase in Mean Squared Error) in explaining the spatial
    variabilty of selected colour and geochemical properties within the
    agricultural and forested sites. Top panel shows an average ranking
    for each site and across both sites.</p></caption>
    <graphic mimetype="image" mime-subtype="png" xlink:href="RF_results_files/figure-jats/fig-RF-results-1.png" />
  </fig>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-4-nb-4">
<front-stub>
<title-group>
<article-title>Lithium Forest site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-4">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-4" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-4">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-4" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;li&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-4">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-4" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = li)) +
  scale_fill_viridis_c(name = &quot;Li&quot;, breaks = seq(4, 9, 1)) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-4" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Li_Forest_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-4">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-4" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-4">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-4" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-4">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-4" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -li), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-4" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-4" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( vertical_distance_channel_network ~ catchment_area ):  -0.0008397144 
max correlation ( vertical_distance_channel_network ~ saga_wetness_index ):  -0.6528616 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 2.617416
2                    plan_curvature 1.058396
3                 profile_curvature 1.713930
4                saga_wetness_index 1.860201
5                    catchment_area 1.551615
6           relative_slope_position 2.898799
7 vertical_distance_channel_network 2.788326</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-4">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-4" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-4" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-4" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-4" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-4">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-4" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(li ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Li_Forest_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-4" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-4">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-4" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(li ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$li,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -li))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-4" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = li ~ ., data = select(filter(train, dataset ==      &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE, importance = TRUE,      mtry = my_mtry, ytest = select(filter(train, dataset == &quot;validation&quot;),          -dataset)$li, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -li)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.2291627
                    % Var explained: 40.46
                       Test set MSE: 0.23
                    % Var explained: 40.69</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-4" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Li_Forest_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-4">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-4" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$li)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Li_Forest_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-4" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.97856 -0.16454 -0.01077  0.15842  0.98666 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  3.96345    0.09350   42.39   &lt;2e-16 ***
obs          0.38026    0.01441   26.38   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2738 on 882 degrees of freedom
Multiple R-squared:  0.4411,    Adjusted R-squared:  0.4404 
F-statistic:   696 on 1 and 882 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-4" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-4" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-4">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-4" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-4">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-4" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-4" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 152.83177     345.37631                         elevation
6  82.75877     148.72557           relative_slope_position
7  46.63579     126.90774 vertical_distance_channel_network
4  44.82318     119.89370                saga_wetness_index
5  28.91104      92.78723                    catchment_area
3  26.17568      91.64210                 profile_curvature
2  15.77940      82.28753                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-4" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-4">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-4" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-4" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 152.83177     345.37631                         elevation
6  82.75877     148.72557           relative_slope_position
7  46.63579     126.90774 vertical_distance_channel_network
4  44.82318     119.89370                saga_wetness_index
5  28.91104      92.78723                    catchment_area
3  26.17568      91.64210                 profile_curvature
2  15.77940      82.28753                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-4" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-4">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-4" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="Li_Forest_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-4">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-4" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Forest&quot;,
        property = &quot;Li&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-4" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-5-nb-5">
<front-stub>
<title-group>
<article-title>Calcium Ag site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-5">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-5" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-5">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-5" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;ca&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-5">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-5" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = ca)) +
  scale_fill_viridis_c(name = &quot;Ca&quot;, limits = c(1, 9.2), breaks = seq(1, 9, 2)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-5" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Ca_Ag_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-5">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-5" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-5">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-5" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-5">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-5" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -ca), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-5" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-5" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( profile_curvature ~ elevation ):  0.002419244 
max correlation ( saga_wetness_index ~ elevation ):  -0.8977745 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 5.545539
2                    plan_curvature 1.350442
3                 profile_curvature 1.315861
4                saga_wetness_index 5.372984
5                    catchment_area 1.240758
6           relative_slope_position 2.262207
7 vertical_distance_channel_network 1.811908</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-5">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-5" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-5" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-5" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-5" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-5">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-5" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(ca ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Ca_Ag_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-5" specific-use="notebook-output">
  <preformat>[1] 4</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-5">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-5" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(ca ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$ca,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -ca))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-5" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = ca ~ ., data = select(filter(train, dataset ==      &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE, importance = TRUE,      mtry = my_mtry, ytest = select(filter(train, dataset == &quot;validation&quot;),          -dataset)$ca, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -ca)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 4

          Mean of squared residuals: 0.3283942
                    % Var explained: 92.62
                       Test set MSE: 0.3
                    % Var explained: 93.09</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-5" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Ca_Ag_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-5">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-5" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$ca)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Ca_Ag_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-5" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
     Min       1Q   Median       3Q      Max 
-2.36383 -0.25051 -0.05731  0.21289  1.98418 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.358211   0.043063   8.318 4.03e-16 ***
obs         0.917338   0.009485  96.712  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5407 on 771 degrees of freedom
Multiple R-squared:  0.9238,    Adjusted R-squared:  0.9237 
F-statistic:  9353 on 1 and 771 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-5" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-5" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-5">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-5" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-5">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-5" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-5" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 189.96075     7215.2462                         elevation
4  44.97244     2216.0853                saga_wetness_index
6  22.36863      309.3720           relative_slope_position
5  32.84647      184.4705                    catchment_area
7  26.23205      174.3916 vertical_distance_channel_network
3  24.26763      151.8472                 profile_curvature
2  17.32975      122.3135                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-5" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-5">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-5" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-5" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 189.96075     7215.2462                         elevation
4  44.97244     2216.0853                saga_wetness_index
5  32.84647      184.4705                    catchment_area
7  26.23205      174.3916 vertical_distance_channel_network
3  24.26763      151.8472                 profile_curvature
6  22.36863      309.3720           relative_slope_position
2  17.32975      122.3135                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-5" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-5">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-5" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="Ca_Ag_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-5">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-5" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Agriculture&quot;,
        property = &quot;Ca&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-5" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-6-nb-6">
<front-stub>
<title-group>
<article-title>Soil property mapping</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-6">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-6" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(terra)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-6">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-6" specific-use="notebook-code">
  <code language="r script">ag_data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) 
  # select(&quot;x&quot;, &quot;y&quot;, &quot;elevation&quot;, &quot;ca&quot;, &quot;mo&quot;, &quot;u&quot;, &quot;a_col&quot;, &quot;h_col&quot;, &quot;c_col&quot;, &quot;organic&quot;, &quot;ssa&quot;)

forest_data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) 
  # select(&quot;x&quot;, &quot;y&quot;, &quot;elevation&quot;, &quot;li&quot;, &quot;nb&quot;, &quot;zn&quot;, &quot;v_col&quot;, &quot;l_col&quot;)
  </code>
  </sec>
</sec>
<sec id="agricultural-soil-properties-nb-6">
  <title>Agricultural soil properties</title>
  <sec id="geochemisty-and-colour-nb-6">
    <title>Geochemisty and colour</title>
    <sec id="nb-code-cell-3-nb-6" specific-use="notebook-code">
    <code language="r script">ag_rast &lt;- rast(ag_data)
crs(x = ag_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

theme_right &lt;-  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;right&quot;,
        legend.box.spacing = unit(0, &quot;pt&quot;),
        legend.margin=margin(0,0,0,3),
        legend.justification=&quot;left&quot;,
        legend.title = element_text(hjust = 0))
theme_left &lt;-  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;left&quot;,
        legend.text.position = &quot;left&quot;,
        legend.box.spacing = unit(0, &quot;pt&quot;),
        legend.margin=margin(0,3,0,0),
        legend.justification=&quot;right&quot;,
        legend.title = element_text(hjust = 1))

a_col &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = a_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;a*&quot;)), breaks = seq(2.5, 4, 0.5)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

c_col &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = c_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;c*&quot;)), breaks = seq(7, 11, 1)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) + 
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

h_col &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = h_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;h*&quot;)), breaks = seq(1.15, 1.25, 0.02)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

ca &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = ca)) +
  scale_fill_viridis_c(name = &quot;Ca&quot;, limits = c(1, 9.2), breaks = seq(1, 9, 2)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

mo &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = mo)) +
  scale_fill_viridis_c(name = &quot;Mo&quot;, breaks = seq(0.5, 2, 0.5)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

u &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = u)) +
  scale_fill_viridis_c(name = &quot;U&quot;, breaks = seq(1.2, 1.8, 0.2)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))
    </code>
    </sec>
    <sec id="cell-fig-ag_map-nb-6" specific-use="notebook-code">
    <code language="r script">
a_col + ca + c_col + mo + h_col + u + 
  plot_layout(ncol = 2) 
    </code>
    <fig id="fig-ag_map-nb-6">
      <caption><p>Kriged map of select colour (<italic>a*</italic>,
      <italic>c*</italic>, <italic>h*</italic>) and geochemical (Ca, Mo,
      U) properties across the agricultural site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="soil_property_maps_files/figure-jats/fig-ag_map-1.png" />
    </fig>
    </sec>
  </sec>
  <sec id="grain-size-om-elevation-nb-6">
    <title>Grain size, OM, elevation</title>
    <sec id="nb-code-cell-4-nb-6" specific-use="notebook-code">
    <code language="r script">dem &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

ssa &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = ssa)) +
  scale_fill_viridis_c(name = &quot;SSA&quot;) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

organic &lt;- ggplot() +
  tidyterra::geom_spatraster(data = ag_rast, aes(fill = organic)) +
  scale_fill_viridis_c(name = &quot;Organic&quot;) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

scale_p &lt;- ggplot() +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;), colour = &quot;white&quot;) +
  theme_void(base_size = 12)+
  ggspatial::annotation_scale(location = &quot;bl&quot;, width_hint = 0.4) +
  ggspatial::annotation_north_arrow(location = &quot;bl&quot;, pad_y  = unit(2, &quot;cm&quot;))
    </code>
    </sec>
    <sec id="cell-fig-ag_map2-nb-6" specific-use="notebook-code">
    <code language="r script">
organic + ssa + dem + scale_p + 
  plot_layout(ncol = 2) 
    </code>
    <fig id="fig-ag_map2-nb-6">
      <caption><p>Kriged map of organic matter content (%), specific
      surface area (m2 kg-1), and elevation (m) across the agricultural
      site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="soil_property_maps_files/figure-jats/fig-ag_map2-1.png" />
    </fig>
    </sec>
  </sec>
</sec>
<sec id="agricultural-soil-properties-1-nb-6">
  <title>Agricultural soil properties</title>
  <sec id="geochemisty-and-colour-1-nb-6">
    <title>Geochemisty and colour</title>
    <sec id="nb-code-cell-5-nb-6" specific-use="notebook-code">
    <code language="r script">forest_rast &lt;- rast(forest_data)
crs(x = forest_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

h_col_forest &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = h_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;h*&quot;)), limits =c(1.05, 1.25), breaks = seq(1.05, 1.25, 0.1)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

l_col &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = l_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;L&quot;)), limits =c(34, 60), breaks = seq(35, 60, 10)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) + 
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

v_col &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = v_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;v*&quot;)), breaks = seq(2, 7, 1)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

nb &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = nb)) +
  scale_fill_viridis_c(name = &quot;Nb&quot;, breaks = seq(0.25, 0.5, 0.05)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

li &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = li)) +
  scale_fill_viridis_c(name = &quot;Li&quot;, breaks = seq(4, 9, 1)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) 

zn &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = zn)) +
  scale_fill_viridis_c(name = &quot;Zn&quot;, breaks = seq(50, 350, 50)) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))
    </code>
    </sec>
    <sec id="cell-fig-forest_map-nb-6" specific-use="notebook-code">
    <code language="r script">
h_col_forest + li + l_col + nb + v_col + zn + 
  plot_layout(ncol = 2) 
    </code>
    <fig id="fig-forest_map-nb-6">
      <caption><p>Kriged map of select colour (<italic>h*</italic>,
      <italic>c*</italic>, <italic>v*</italic>) and geochemical (Li, Nb,
      Zn) properties across the forested site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="soil_property_maps_files/figure-jats/fig-forest_map-1.png" />
    </fig>
    </sec>
  </sec>
  <sec id="grain-size-om-elevation-1-nb-6">
    <title>Grain size, OM, elevation</title>
    <sec id="nb-code-cell-6-nb-6" specific-use="notebook-code">
    <code language="r script">dem_forest &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation&quot;, option = &quot;inferno&quot;) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

ssa_forest &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = ssa)) +
  scale_fill_viridis_c(name = &quot;SSA&quot;) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_right +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

organic_forest &lt;- ggplot() +
  tidyterra::geom_spatraster(data = forest_rast, aes(fill = organic)) +
  scale_fill_viridis_c(name = &quot;Organic&quot;) +
  #geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_minimal(base_size = 12) +
  theme_left +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0))

scale_p_forest &lt;- ggplot() +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;), colour = &quot;white&quot;) +
  theme_void(base_size = 12)+
  ggspatial::annotation_scale(location = &quot;bl&quot;, width_hint = 0.3) +
  ggspatial::annotation_north_arrow(location = &quot;bl&quot;, pad_y  = unit(2, &quot;cm&quot;))
    </code>
    </sec>
    <sec id="cell-fig-forest_map2-nb-6" specific-use="notebook-code">
    <code language="r script">
organic_forest + ssa_forest + dem_forest + scale_p_forest + 
  plot_layout(ncol = 2) 
    </code>
    <fig id="fig-forest_map2-nb-6">
      <caption><p>Kriged map of organic matter content (%), specific
      surface area (m2 kg-1), and elevation (m) across the forested
      site.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="soil_property_maps_files/figure-jats/fig-forest_map2-1.png" />
    </fig>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-7-nb-7">
<front-stub>
<title-group>
<article-title>Semivariograms</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-7">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-7" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(gt)
})
  </code>
  </sec>
</sec>
<sec id="data-nb-7">
  <title>Data</title>
  <sec id="nb-code-cell-2-nb-7" specific-use="notebook-code">
  <code language="r script">geochem_vario &lt;- tribble(
  ~Property, ~Model, ~`Nugget (Co)`, ~`Sill (Co)`, ~`Range (m)`, ~`C/(C + Co) (%)`, ~Class, ~R2, ~RMSE, ~site,
  &quot;Ca&quot;,      &quot;Exp&quot;,  0.00,         1.49,          72.52,     0.00,          &quot;S&quot;,    0.27, 1.8, &quot;Agriculture&quot;, 
  &quot;Ca&quot;,      &quot;Exp&quot;,  0.00,         1.49,          72.52,     0.00,          &quot;S&quot;,    0.27, 1.8, &quot;Forest&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-3-nb-7" specific-use="notebook-code">
  <code language="r script">
geochem_vario |&gt;
  group_by(site) |&gt;
  gt() |&gt;
  tab_footnote(
    footnote = &quot;Models are all isotropic.&quot;,
    locations = cells_column_labels(columns = Model))  |&gt;
  tab_footnote(
    footnote = &quot;S = strong spatial dependency (C/(C + Co) % &gt;75); M = moderate spatial dependency (C/(C + Co) % between
75 and 25).&quot;,
    locations = cells_column_labels(columns = Class))  |&gt;
  tab_style(style =  cell_text(weight = &quot;bold&quot;, align = &quot;center&quot;), locations =  cells_row_groups()) |&gt;
  tab_options(column_labels.font.weight = &quot;bold&quot;)
  </code>
  <fig id="tbl-geochem-semivariogram-nb-7">
    <caption><p>Geostatistical parameters of the fitted semivariogram
    models for six examples of geochemical and colour fingerprint
    properties for each site.</p></caption>
  </fig>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-8-nb-8">
<front-stub>
<title-group>
<article-title>Niobium Forest site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-8">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-8" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-8">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-8" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;nb&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-8">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-8" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = nb)) +
  scale_fill_viridis_c(name = &quot;Nb&quot;, breaks = seq(0.25, 0.5, 0.05)) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-8" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Nb_Forest_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-8">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-8" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-8">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-8" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-8">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-8" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -nb), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-8" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-8" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( vertical_distance_channel_network ~ catchment_area ):  -0.0008397144 
max correlation ( vertical_distance_channel_network ~ saga_wetness_index ):  -0.6528616 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 2.617416
2                    plan_curvature 1.058396
3                 profile_curvature 1.713930
4                saga_wetness_index 1.860201
5                    catchment_area 1.551615
6           relative_slope_position 2.898799
7 vertical_distance_channel_network 2.788326</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-8">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-8" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-8" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-8" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-8" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-8">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-8" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(nb ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Nb_Forest_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-8" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-8">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-8" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(nb ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$nb,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -nb))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-8" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = nb ~ ., data = select(filter(train, dataset ==      &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE, importance = TRUE,      mtry = my_mtry, ytest = select(filter(train, dataset == &quot;validation&quot;),          -dataset)$nb, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -nb)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.0003950932
                    % Var explained: 58
                       Test set MSE: 0
                    % Var explained: 56.52</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-8" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Nb_Forest_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-8">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-8" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$nb)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Nb_Forest_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-8" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.043606 -0.008666 -0.000205  0.008046  0.068014 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.15242    0.00579   26.32   &lt;2e-16 ***
obs          0.58676    0.01551   37.82   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.01428 on 882 degrees of freedom
Multiple R-squared:  0.6186,    Adjusted R-squared:  0.6181 
F-statistic:  1430 on 1 and 882 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-8" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-8" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-8">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-8" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-8">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-8" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-8" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 160.38422     0.8676801                         elevation
4  60.98920     0.5533080                saga_wetness_index
7  64.31257     0.2892451 vertical_distance_channel_network
3  51.62328     0.2359234                 profile_curvature
5  49.04056     0.2117256                    catchment_area
6  46.44613     0.1934459           relative_slope_position
2  19.20994     0.1315285                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-8" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-8">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-8" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-8" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 160.38422     0.8676801                         elevation
7  64.31257     0.2892451 vertical_distance_channel_network
4  60.98920     0.5533080                saga_wetness_index
3  51.62328     0.2359234                 profile_curvature
5  49.04056     0.2117256                    catchment_area
6  46.44613     0.1934459           relative_slope_position
2  19.20994     0.1315285                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-8" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-8">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-8" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="Nb_Forest_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-8">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-8" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Forest&quot;,
        property = &quot;Nb&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-8" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-9-nb-9">
<front-stub>
<title-group>
<article-title>Research Site Locations</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="nb-code-cell-1-nb-9" specific-use="notebook-code">
<code language="r script">suppressPackageStartupMessages({library(tidyverse)
library(ggspatial)
library(sf)
library(rnaturalearth)
library(ggrepel)
library(raster)
library(patchwork)
})
</code>
</sec>
<sec id="bounding-box-of-region-and-sites-nb-9">
  <title>Bounding box of region and sites</title>
  <sec id="nb-code-cell-2-nb-9" specific-use="notebook-code">
  <code language="r script">box = c(xmin = 455200, ymin = 5616000, xmax = 466200, ymax = 5626500)

ag_site &lt;- data.frame(x = c(464124, 463318),
                         y = c(5622932, 5622121)) %&gt;% 
  st_as_sf(coords = c(&quot;x&quot;, &quot;y&quot;), crs = 3158) %&gt;% 
  st_bbox() %&gt;% 
  st_as_sfc()

forest_site &lt;- data.frame(x = c(460822, 460189),
                         y = c(5619887, 5619206)) %&gt;% 
  st_as_sf(coords = c(&quot;x&quot;, &quot;y&quot;), crs = 3158) %&gt;% 
  st_bbox() %&gt;% 
  st_as_sfc()

locations &lt;- data.frame(name = c(&quot;Forest&quot;, &quot;Agriculture&quot;), 
                        long = c(-99.560041, -99.513808), 
                        lat = c( 50.726076,  50.752731)) %&gt;%
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326)

  #st_transform(crs = st_crs(land))

cities &lt;- data.frame(name = &quot;McCreary&quot;, long = -99.493, lat = 50.775) %&gt;%
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) 
  </code>
  </sec>
</sec>
<sec id="land-use-data-of-region-nb-9">
  <title>Land use data of region</title>
  <sec id="get-data-nb-9">
    <title>Get data</title>
    <sec id="nb-code-cell-3-nb-9" specific-use="notebook-code">
    <code language="r script">minnedosa_data &lt;- &quot;lcv_minnedosa_2004_2006_shp&quot;
if (file.exists(minnedosa_data)) {
  print(&quot;The data already exists!&quot;)
} else {
  download.file(&quot;https://mli.gov.mb.ca/landuse/shp_zip_files/lcv_minnedosa_2004_2006_shp.zip&quot;, 
                destfile = &quot;lcv_minnedosa_2004_2006_shp.zip&quot;)
  unzip(&quot;lcv_minnedosa_2004_2006_shp.zip&quot;, exdir = &quot;lcv_minnedosa_2004_2006_shp&quot;)
}
    </code>
    <sec id="nb-code-cell-3-output-0-nb-9" specific-use="notebook-output">
    <preformat>[1] &quot;The data already exists!&quot;</preformat>
    </sec>
    </sec>
  </sec>
  <sec id="summarize-and-crop-nb-9">
    <title>Summarize and crop</title>
    <sec id="nb-code-cell-4-nb-9" specific-use="notebook-code">
    <code language="r script">land &lt;- st_read(here::here(&quot;./notebooks/lcv_minnedosa_2004_2006_shp/lcv_minnedosa_2004_2006.shp&quot;)) %&gt;%
  st_crop(st_bbox(box)) %&gt;%
  st_transform(4269) %&gt;%
  mutate(Land_use = recode(CLASSNAME, &quot;Agricultural Field&quot; = &quot;Agriculture&quot;, &quot;Agri - Forage Field&quot; = &quot;Agriculture&quot;, &quot;Water Body&quot; = &quot;Water&quot;, &quot;Wetland - Treed Bog&quot; = &quot;Wetland&quot;, &quot;Wetland - Marsh&quot; = &quot;Wetland&quot;, &quot;Decidious Forest&quot; = &quot;Forest&quot;, &quot;Open Decidious Forest&quot; = &quot;Forest&quot;, &quot;Mixedwood Forest&quot; = &quot;Forest&quot;, &quot;Forest Cut Blocks&quot; = &quot;Forest&quot;, &quot;Coniferous Forest&quot; = &quot;Forest&quot;,&quot;Roads Trails Rail Lines&quot; = &quot;Other&quot;, &quot;Sand and Gravel&quot; = &quot;Other&quot;, &quot;Cultural Features&quot; = &quot;Other&quot;, &quot;Range and Grassland&quot; = &quot;Forage&quot;)) %&gt;%
  st_make_valid() %&gt;%
  st_simplify(dTolerance = 0.0001, preserveTopology = F) %&gt;%
  group_by(Land_use) %&gt;%
  summarise(do_union = TRUE) %&gt;%
  mutate(Land_use = factor(Land_use, levels=c(&quot;Agriculture&quot;, &quot;Forest&quot;, &quot;Forage&quot;, &quot;Water&quot;, &quot;Wetland&quot;, &quot;Other&quot;)))
    </code>
    <sec id="nb-code-cell-4-output-0-nb-9" specific-use="notebook-output">
    <preformat>Reading layer `lcv_minnedosa_2004_2006' from data source 
  `/home/alex/Dropbox/Graduate students/Maria/Manucripts/Manuscript 2/spatial-variability-soil-manuscript/notebooks/lcv_minnedosa_2004_2006_shp/lcv_minnedosa_2004_2006.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 160653 features and 5 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 429972 ymin: 5542070 xmax: 549972 ymax: 5656880
Projected CRS: UTM</preformat>
    </sec>
    <sec id="nb-code-cell-4-output-1-nb-9" specific-use="notebook-output">
    <preformat>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</preformat>
    </sec>
    <sec id="nb-code-cell-4-output-2-nb-9" specific-use="notebook-output">
    <preformat>Warning in st_simplify.sfc(st_geometry(x), preserveTopology, dTolerance):
argument preserveTopology cannot be set to FALSE when working with ellipsoidal
coordinates since the algorithm behind st_simplify always preserves topological
relationships</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="dem-data-nb-9">
  <title>DEM data</title>
  <p>Freely available from
  <ext-link ext-link-type="uri" xlink:href="https://maps.canada.ca/czs/index-en.html">https://maps.canada.ca/czs/index-en.html</ext-link>
  Data type is Elevation. You provide the clipping area and then submit
  the data request</p>
  <sec id="nb-code-cell-5-nb-9" specific-use="notebook-code">
  <code language="r script">topo &lt;- raster::aggregate(raster(here::here(&quot;./notebooks/DEM.tif&quot;)), fact = 3) %&gt;%
  crop(extent(land)) %&gt;%
  as.data.frame(xy = T)
  </code>
  </sec>
</sec>
<sec id="hydro-data-nb-9">
  <title>Hydro data</title>
  <p>Freely available from
  <ext-link ext-link-type="uri" xlink:href="https://maps.canada.ca/czs/index-en.html">https://maps.canada.ca/czs/index-en.html</ext-link>
  Data type is the CanVec. You provide the clipping area and then submit
  the data request</p>
  <sec id="nb-code-cell-6-nb-9" specific-use="notebook-code">
  <code language="r script">water_linear &lt;- st_read(here::here(&quot;./notebooks/canvec_190514_89905/water_linear_flow_1.shp&quot;)) %&gt;%
  st_transform(crs = st_crs(land)) %&gt;%
  st_make_valid() %&gt;%
  st_crop(st_bbox(land))
  </code>
  <sec id="nb-code-cell-6-output-0-nb-9" specific-use="notebook-output">
  <preformat>Reading layer `water_linear_flow_1' from data source 
  `/home/alex/Dropbox/Graduate students/Maria/Manucripts/Manuscript 2/spatial-variability-soil-manuscript/notebooks/canvec_190514_89905/water_linear_flow_1.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 5160 features and 44 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: -99.9082 ymin: 50.54151 xmax: -99.12695 ymax: 51.16603
Geodetic CRS:  GCS_North_American_1983_CSRS98</preformat>
  </sec>
  <sec id="nb-code-cell-6-output-1-nb-9" specific-use="notebook-output">
  <preformat>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</preformat>
  </sec>
  </sec>
</sec>
<sec id="canada-wide-map-nb-9">
  <title>Canada wide map</title>
  <sec id="nb-code-cell-7-nb-9" specific-use="notebook-code">
  <code language="r script">canada &lt;- ne_states(country = &quot;Canada&quot;, returnclass = &quot;sf&quot;) %&gt;%
  st_transform(crs = 3348)

locations2 &lt;- data.frame(name = c(&quot;Center&quot;), long = c(-99.989671), lat = c(50.742554)) %&gt;%
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = st_crs(land))
  </code>
  </sec>
</sec>
<sec id="maps-nb-9">
  <title>Maps</title>
  <sec id="canada-nb-9">
    <title>Canada</title>
    <sec id="nb-code-cell-8-nb-9" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot() +
  theme_bw() +
  layer_spatial(canada, fill = &quot;white&quot;) +
  layer_spatial(locations2, shape = 23, colour = &quot;red&quot;, fill = &quot;red&quot;, size = 2) +
  annotation_scale(location = &quot;bl&quot;,
                   height = unit(0.05, &quot;cm&quot;)) +
  annotation_north_arrow(location = &quot;br&quot;, 
                         height = unit(0.5, &quot;cm&quot;),
                         width = unit(0.5, &quot;cm&quot;)) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.margin = unit(c(0,0,0,0), &quot;mm&quot;))
    </code>
    </sec>
  </sec>
  <sec id="land-use-nb-9">
    <title>Land use</title>
    <sec id="nb-code-cell-9-nb-9" specific-use="notebook-code">
    <code language="r script">p2 &lt;- ggplot() +
  theme_bw(base_size = 10) +
  geom_sf(data = land, aes(fill = Land_use)) +
  scale_fill_manual(values=c(&quot;#458B00&quot;, &quot;#006400&quot;, &quot;#CDAD00&quot;, &quot;#009ACD&quot;, &quot;#CDB38B&quot;,  &quot;#C1CDCD&quot;), name = &quot;Land use&quot;) +
  geom_sf(data = water_linear, colour = &quot;#009ACD&quot;, lwd = 0.5) +
  geom_label_repel(
    data = head(locations),
    aes(label = name, geometry = geometry),
    stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    nudge_y = 0.01, 
    size = 3) +
  geom_label_repel(
    data = head(locations),
    aes(label = name, geometry = geometry),
    stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    nudge_y = 0.01, 
    size = 3) +
  geom_sf(data = ag_site, fill = NA, colour = &quot;red&quot;, lwd = 1) +
  geom_sf(data = forest_site, fill = NA, colour = &quot;red&quot;, lwd = 1) +
  geom_label_repel(
    data = head(cities),
    aes(label = name, geometry = geometry),
    stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    nudge_y = 0.01,
    size = 2) +
  annotation_scale(location = &quot;bl&quot;,
                   height = unit(0.05, &quot;cm&quot;)) +
  annotation_north_arrow(location = &quot;br&quot;, 
                         height = unit(0.5, &quot;cm&quot;),
                         width = unit(0.5, &quot;cm&quot;)) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.margin = unit(c(0,0,0,0), &quot;mm&quot;),
        legend.position = &quot;bottom&quot;,
        legend.title = element_blank(),
        legend.key.size = unit(5, 'mm'),
        legend.box.spacing = unit(0, &quot;pt&quot;)) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0))
    </code>
    </sec>
  </sec>
  <sec id="dem-nb-9">
    <title>DEM</title>
    <sec id="nb-code-cell-10-nb-9" specific-use="notebook-code">
    <code language="r script">p3 &lt;- ggplot() +
  theme_bw(base_size = 10) +
  geom_raster(data = topo , aes(x = x, y = y, fill = DEM)) + 
  scale_fill_viridis_c(name = &quot;Elev. (m)  &quot;, limits = c(282, 800), breaks = c(300, 550, 800)) +
  geom_label_repel(
    data = head(locations),
    aes(label = name, geometry = geometry),
    stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    nudge_y = 0.01,
    size = 3) +
  geom_sf(data = ag_site, fill = NA, colour = &quot;red&quot;, lwd = 1) +
  geom_sf(data = forest_site, fill = NA, colour = &quot;red&quot;, lwd = 1) +
  geom_label_repel(
    data = head(cities),
    aes(label = name, geometry = geometry),
    stat = &quot;sf_coordinates&quot;,
    min.segment.length = 0,
    nudge_y = 0.01,
    size = 3) +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
  annotation_scale(location = &quot;bl&quot;,
                   height = unit(0.05, &quot;cm&quot;)) +
  annotation_north_arrow(location = &quot;br&quot;, 
                         height = unit(0.5, &quot;cm&quot;),
                         width = unit(0.5, &quot;cm&quot;)) +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.margin = unit(c(0,0,0,0), &quot;mm&quot;),
        legend.position = &quot;bottom&quot;,
        legend.box.spacing = unit(0, &quot;pt&quot;)) 
    </code>
    </sec>
    <sec id="cell-fig-location_map-nb-9" specific-use="notebook-code">
    <code language="r script">p6 &lt;- p1 + guide_area() + p2 + p3 + plot_layout(ncol = 2, guides = &quot;collect&quot;) 
p6
    </code>
    <code language="r script">#ggsave(filename = &quot;Figures/Maps.png&quot;, plot = p6, height = 80*1.5, width = 100*1.5, units = &quot;mm&quot;, dpi = 800)
    </code>
    <fig id="fig-location_map-nb-9">
      <caption><p>Map showing the location of the study sites within
      Canada, and the regional land use and topography.</p></caption>
      <graphic mimetype="image" mime-subtype="png" xlink:href="location_map_files/figure-jats/fig-location_map-1.png" />
    </fig>
    <sec id="cell-fig-location_map-output-0-nb-9" specific-use="notebook-output">
    <preformat>Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data

Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data

Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data

Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data

Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not
give correct results for longitude/latitude data</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-10-nb-10">
<front-stub>
<title-group>
<article-title>Molybdenum Ag site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-10">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-10" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-10">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-10" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;mo&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-10">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-10" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = mo)) +
  scale_fill_viridis_c(name = &quot;Mo&quot;, breaks = seq(0.5, 2, 0.5)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-10" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Mo_Ag_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-10">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-10" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-10">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-10" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-10">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-10" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -mo), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-10" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-10" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( profile_curvature ~ elevation ):  0.002419244 
max correlation ( saga_wetness_index ~ elevation ):  -0.8977745 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 5.545539
2                    plan_curvature 1.350442
3                 profile_curvature 1.315861
4                saga_wetness_index 5.372984
5                    catchment_area 1.240758
6           relative_slope_position 2.262207
7 vertical_distance_channel_network 1.811908</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-10">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-10" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-10" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-10" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-10" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-10">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-10" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(mo ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Mo_Ag_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-10" specific-use="notebook-output">
  <preformat>[1] 4</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-10">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-10" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(mo ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$mo,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -mo))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-10" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = mo ~ ., data = select(filter(train, dataset ==      &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE, importance = TRUE,      mtry = my_mtry, ytest = select(filter(train, dataset == &quot;validation&quot;),          -dataset)$mo, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -mo)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 4

          Mean of squared residuals: 0.01612777
                    % Var explained: 83.38
                       Test set MSE: 0.01
                    % Var explained: 84.38</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-10" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Mo_Ag_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-10">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-10" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$mo)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Mo_Ag_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-10" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.48150 -0.06701 -0.01354  0.06260  0.57605 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.18715    0.01225   15.28   &lt;2e-16 ***
obs          0.79186    0.01315   60.23   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1127 on 771 degrees of freedom
Multiple R-squared:  0.8247,    Adjusted R-squared:  0.8245 
F-statistic:  3627 on 1 and 771 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-10" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-10" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-10">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-10" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-10">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-10" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-10" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 104.45053    107.142723                         elevation
4  33.90563     52.423666                saga_wetness_index
6  63.44454     21.543902           relative_slope_position
3  49.74089     16.299233                 profile_curvature
7  42.82818     11.454363 vertical_distance_channel_network
5  33.53180      8.734249                    catchment_area
2  17.69650      6.597479                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-10" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-10">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-10" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-10" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 104.45053    107.142723                         elevation
6  63.44454     21.543902           relative_slope_position
3  49.74089     16.299233                 profile_curvature
7  42.82818     11.454363 vertical_distance_channel_network
4  33.90563     52.423666                saga_wetness_index
5  33.53180      8.734249                    catchment_area
2  17.69650      6.597479                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-10" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-10">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-10" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="Mo_Ag_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-10">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-10" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Agriculture&quot;,
        property = &quot;Mo&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-10" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-11-nb-11">
<front-stub>
<title-group>
<article-title>L (CIE metric lightness) Forest site
RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-11">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-11" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-11">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-11" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;l_col&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-11">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-11" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;)) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)
  </code>
  <code language="r script">p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = l_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;L&quot;)), limits =c(34, 60), breaks = seq(35, 60, 10)) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  <sec id="nb-code-cell-3-output-0-nb-11" specific-use="notebook-output">
  <preformat>Rows: 98 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (1): site
dbl (2): long, lat

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-4-nb-11" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="l_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-11">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-11" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-11">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-11" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-11">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-11" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -l_col), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-11" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-11" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( vertical_distance_channel_network ~ catchment_area ):  -0.0008397144 
max correlation ( vertical_distance_channel_network ~ saga_wetness_index ):  -0.6528616 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 2.617416
2                    plan_curvature 1.058396
3                 profile_curvature 1.713930
4                saga_wetness_index 1.860201
5                    catchment_area 1.551615
6           relative_slope_position 2.898799
7 vertical_distance_channel_network 2.788326</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-11">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-11" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-11" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-11" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-11" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-11">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-11" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(l_col ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="l_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-11" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-11">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-11" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(l_col ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$l_col,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -l_col))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-11" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = l_col ~ ., data = select(filter(train,      dataset == &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE,      importance = TRUE, mtry = my_mtry, ytest = select(filter(train,          dataset == &quot;validation&quot;), -dataset)$l_col, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -l_col)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 9.581256
                    % Var explained: 55.7
                       Test set MSE: 9.89
                    % Var explained: 57.39</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-11" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="l_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-11">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-11" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$l_col)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="l_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-11" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
    Min      1Q  Median      3Q     Max 
-8.1974 -1.2925 -0.1456  1.3698  7.7173 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 22.37234    0.70627   31.68   &lt;2e-16 ***
obs          0.52392    0.01487   35.23   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.096 on 882 degrees of freedom
Multiple R-squared:  0.5846,    Adjusted R-squared:  0.5842 
F-statistic:  1241 on 1 and 882 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-11" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-11" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-11">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-11" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-11">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-11" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-11" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 184.64061     19877.090                         elevation
7  52.63345      7916.199 vertical_distance_channel_network
6  86.75780      7037.523           relative_slope_position
4  39.72247      6524.905                saga_wetness_index
5  51.03704      6173.721                    catchment_area
3  45.35584      5871.605                 profile_curvature
2  24.88106      3667.341                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-11" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-11">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-11" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-11" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 184.64061     19877.090                         elevation
6  86.75780      7037.523           relative_slope_position
7  52.63345      7916.199 vertical_distance_channel_network
5  51.03704      6173.721                    catchment_area
3  45.35584      5871.605                 profile_curvature
4  39.72247      6524.905                saga_wetness_index
2  24.88106      3667.341                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-11" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-11">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-11" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="l_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-11">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-11" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Forest&quot;,
        property = &quot;l_col&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-11" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-12-nb-12">
<front-stub>
<title-group>
<article-title>c* (CIE hue) Ag site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-12">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-12" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-12">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-12" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;c_col&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-12">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-12" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = c_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;c*&quot;)), breaks = seq(7, 11, 1)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-12" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="c_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-12">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-12" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-12">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-12" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-12">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-12" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -c_col), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-12" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-12" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( profile_curvature ~ elevation ):  0.002419244 
max correlation ( saga_wetness_index ~ elevation ):  -0.8977745 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 5.545539
2                    plan_curvature 1.350442
3                 profile_curvature 1.315861
4                saga_wetness_index 5.372984
5                    catchment_area 1.240758
6           relative_slope_position 2.262207
7 vertical_distance_channel_network 1.811908</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-12">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-12" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-12" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-12" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-12" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-12">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-12" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(c_col ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="c_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-12" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-12">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-12" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(c_col ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$c_col,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -c_col))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-12" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = c_col ~ ., data = select(filter(train,      dataset == &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE,      importance = TRUE, mtry = my_mtry, ytest = select(filter(train,          dataset == &quot;validation&quot;), -dataset)$c_col, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -c_col)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.1541467
                    % Var explained: 73.36
                       Test set MSE: 0.14
                    % Var explained: 75.54</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-12" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="c_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-12">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-12" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$c_col)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="c_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-12" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.38766 -0.17726  0.03623  0.20857  1.10810 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  3.24325    0.13473   24.07   &lt;2e-16 ***
obs          0.65413    0.01442   45.37   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3112 on 771 degrees of freedom
Multiple R-squared:  0.7275,    Adjusted R-squared:  0.7271 
F-statistic:  2058 on 1 and 771 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-12" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-12" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-12">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-12" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-12">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-12" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-12" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 150.72419     572.79041                         elevation
4  87.99479     211.92341                saga_wetness_index
6  72.99302     173.34314           relative_slope_position
3  69.04689     142.44646                 profile_curvature
7  59.54704     114.14983 vertical_distance_channel_network
5  43.07191      73.89984                    catchment_area
2  19.62285      47.63269                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-12" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-12">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-12" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-12" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 150.72419     572.79041                         elevation
4  87.99479     211.92341                saga_wetness_index
6  72.99302     173.34314           relative_slope_position
3  69.04689     142.44646                 profile_curvature
7  59.54704     114.14983 vertical_distance_channel_network
5  43.07191      73.89984                    catchment_area
2  19.62285      47.63269                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-12" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-12">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-12" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="c_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-12">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-12" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Agriculture&quot;,
        property = &quot;c_col&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-12" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-13-nb-13">
<front-stub>
<title-group>
<article-title>h* (CIE chroma) Forest site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-13">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-13" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-13">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-13" specific-use="notebook-code">
  <code language="r script">attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;h_col&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-13">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-13" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;)) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)
  </code>
  <code language="r script">p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = h_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;h*&quot;)), limits =c(1.05, 1.25), breaks = seq(1.05, 1.25, 0.1)) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  <sec id="nb-code-cell-3-output-0-nb-13" specific-use="notebook-output">
  <preformat>Rows: 98 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (1): site
dbl (2): long, lat

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-4-nb-13" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-13">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-13" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-13">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-13" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-13">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-13" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -h_col), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-13" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-13" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( vertical_distance_channel_network ~ catchment_area ):  -0.0008397144 
max correlation ( vertical_distance_channel_network ~ saga_wetness_index ):  -0.6528616 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 2.617416
2                    plan_curvature 1.058396
3                 profile_curvature 1.713930
4                saga_wetness_index 1.860201
5                    catchment_area 1.551615
6           relative_slope_position 2.898799
7 vertical_distance_channel_network 2.788326</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-13">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-13" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-13" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-13" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-13" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-13">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-13" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(h_col ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-13" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-13">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-13" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(h_col ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$h_col,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -h_col))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-13" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = h_col ~ ., data = select(filter(train,      dataset == &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE,      importance = TRUE, mtry = my_mtry, ytest = select(filter(train,          dataset == &quot;validation&quot;), -dataset)$h_col, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -h_col)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.0006793352
                    % Var explained: 52.97
                       Test set MSE: 0
                    % Var explained: 55</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-13" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-13">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-13" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$h_col)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-13" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.071596 -0.011660 -0.000529  0.011214  0.056261 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.54935    0.01712   32.08   &lt;2e-16 ***
obs          0.51502    0.01510   34.11   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.01711 on 882 degrees of freedom
Multiple R-squared:  0.5688,    Adjusted R-squared:  0.5683 
F-statistic:  1163 on 1 and 882 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-13" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-13" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-13">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-13" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-13">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-13" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-13" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 169.13738     1.1016109                         elevation
7  50.98879     0.5756940 vertical_distance_channel_network
6 100.55054     0.5248328           relative_slope_position
4  41.15716     0.5236309                saga_wetness_index
3  47.16543     0.4264732                 profile_curvature
5  48.73359     0.4015486                    catchment_area
2  23.73369     0.2515695                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-13" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-13">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-13" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-13" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 169.13738     1.1016109                         elevation
6 100.55054     0.5248328           relative_slope_position
7  50.98879     0.5756940 vertical_distance_channel_network
5  48.73359     0.4015486                    catchment_area
3  47.16543     0.4264732                 profile_curvature
4  41.15716     0.5236309                saga_wetness_index
2  23.73369     0.2515695                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-13" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-13">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-13" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Forest_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-13">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-13" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Forest&quot;,
        property = &quot;h_col&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-13" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-14-nb-14">
<front-stub>
<title-group>
<article-title>a* (opponent red–green scales) Ag site
RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-14">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-14" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-14">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-14" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;a_col&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-14">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-14" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = a_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;a*&quot;)), breaks = seq(2.5, 4, 0.5)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-14" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="a_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-14">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-14" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-14">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-14" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-14">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-14" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -a_col), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-14" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-14" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( profile_curvature ~ elevation ):  0.002419244 
max correlation ( saga_wetness_index ~ elevation ):  -0.8977745 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 5.545539
2                    plan_curvature 1.350442
3                 profile_curvature 1.315861
4                saga_wetness_index 5.372984
5                    catchment_area 1.240758
6           relative_slope_position 2.262207
7 vertical_distance_channel_network 1.811908</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-14">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-14" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-14" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-14" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-14" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-14">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-14" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(a_col ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="a_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-14" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-14">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-14" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(a_col ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$a_col,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -a_col))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-14" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = a_col ~ ., data = select(filter(train,      dataset == &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE,      importance = TRUE, mtry = my_mtry, ytest = select(filter(train,          dataset == &quot;validation&quot;), -dataset)$a_col, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -a_col)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.008123747
                    % Var explained: 83.07
                       Test set MSE: 0.01
                    % Var explained: 85.44</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-14" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="a_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-14">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-14" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$a_col)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="a_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-14" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.38681 -0.03747  0.00245  0.05006  0.46928 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.76553    0.04252   18.01   &lt;2e-16 ***
obs          0.77182    0.01271   60.70   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.07917 on 771 degrees of freedom
Multiple R-squared:  0.827, Adjusted R-squared:  0.8267 
F-statistic:  3685 on 1 and 771 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-14" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-14" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-14">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-14" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-14">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-14" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-14" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 221.51610     65.368754                         elevation
6  82.51102     12.589828           relative_slope_position
4  74.11373     10.884643                saga_wetness_index
3  51.31206      8.700636                 profile_curvature
7  57.74620      6.973820 vertical_distance_channel_network
5  32.16983      4.273399                    catchment_area
2  17.91000      2.622025                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-14" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-14">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-14" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-14" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 221.51610     65.368754                         elevation
6  82.51102     12.589828           relative_slope_position
4  74.11373     10.884643                saga_wetness_index
7  57.74620      6.973820 vertical_distance_channel_network
3  51.31206      8.700636                 profile_curvature
5  32.16983      4.273399                    catchment_area
2  17.91000      2.622025                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-14" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-14">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-14" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="a_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-14">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-14" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Agriculture&quot;,
        property = &quot;a_col&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-14" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-15-nb-15">
<front-stub>
<title-group>
<article-title>Zinc Forest site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-15">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-15" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-15">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-15" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/forest_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;zn&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-15">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-15" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = zn)) +
  scale_fill_viridis_c(name = &quot;Zn&quot;, breaks = seq(50, 350, 50)) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;) +
  geom_sf(data = filter(coords, site == &quot;Forest&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-15" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Zn_Forest_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-15">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-15" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-15">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-15" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-15">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-15" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -zn), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-15" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-15" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( vertical_distance_channel_network ~ catchment_area ):  -0.0008397144 
max correlation ( vertical_distance_channel_network ~ saga_wetness_index ):  -0.6528616 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 2.617416
2                    plan_curvature 1.058396
3                 profile_curvature 1.713930
4                saga_wetness_index 1.860201
5                    catchment_area 1.551615
6           relative_slope_position 2.898799
7 vertical_distance_channel_network 2.788326</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-15">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-15" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-15" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-15" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-15" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-15">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-15" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(zn ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Zn_Forest_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-15" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-15">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-15" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(zn ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$zn,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -zn))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-15" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = zn ~ ., data = select(filter(train, dataset ==      &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE, importance = TRUE,      mtry = my_mtry, ytest = select(filter(train, dataset == &quot;validation&quot;),          -dataset)$zn, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -zn)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 799.9475
                    % Var explained: 56.35
                       Test set MSE: 838.89
                    % Var explained: 55.12</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-15" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Zn_Forest_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-15">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-15" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$zn)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="Zn_Forest_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-15" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
    Min      1Q  Median      3Q     Max 
-69.793 -13.487  -1.689  10.982 120.499 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 53.56470    2.00762   26.68   &lt;2e-16 ***
obs          0.52503    0.01663   31.57   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 21.42 on 882 degrees of freedom
Multiple R-squared:  0.5305,    Adjusted R-squared:   0.53 
F-statistic: 996.7 on 1 and 882 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-15" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-15" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-15">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-15" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-15">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-15" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-15" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 136.11705     1583157.6                         elevation
3  55.79305      661776.2                 profile_curvature
7  52.70561      606978.4 vertical_distance_channel_network
4  49.36095      588981.4                saga_wetness_index
6  78.37539      544892.8           relative_slope_position
5  39.91725      477541.6                    catchment_area
2  28.52077      368626.8                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-15" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-15">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-15" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-15" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 136.11705     1583157.6                         elevation
6  78.37539      544892.8           relative_slope_position
3  55.79305      661776.2                 profile_curvature
7  52.70561      606978.4 vertical_distance_channel_network
4  49.36095      588981.4                saga_wetness_index
5  39.91725      477541.6                    catchment_area
2  28.52077      368626.8                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-15" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-15">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-15" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="Zn_Forest_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-15">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-15" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Forest&quot;,
        property = &quot;Zn&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-15" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-16-nb-16">
<front-stub>
<title-group>
<article-title>Uranium Ag site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-16">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-16" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-16">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-16" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;u&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-16">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-16" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = u)) +
  scale_fill_viridis_c(name = &quot;U&quot;, breaks = seq(1.2, 1.8, 0.2)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-16" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="U_Ag_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-16">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-16" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-16">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-16" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-16">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-16" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -u), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-16" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-16" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( profile_curvature ~ elevation ):  0.002419244 
max correlation ( saga_wetness_index ~ elevation ):  -0.8977745 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 5.545539
2                    plan_curvature 1.350442
3                 profile_curvature 1.315861
4                saga_wetness_index 5.372984
5                    catchment_area 1.240758
6           relative_slope_position 2.262207
7 vertical_distance_channel_network 1.811908</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-16">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-16" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-16" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-16" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-16" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-16">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-16" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(u ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="U_Ag_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-16" specific-use="notebook-output">
  <preformat>[1] 7</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-16">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-16" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(u ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$u,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -u))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-16" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = u ~ ., data = select(filter(train, dataset ==      &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE, importance = TRUE,      mtry = my_mtry, ytest = select(filter(train, dataset == &quot;validation&quot;),          -dataset)$u, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -u)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 7

          Mean of squared residuals: 0.0009508159
                    % Var explained: 94.8
                       Test set MSE: 0
                    % Var explained: 93.68</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-16" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="U_Ag_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-16">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-16" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$u)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="U_Ag_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-16" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.118454 -0.013468  0.001198  0.015903  0.091310 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.090712   0.012079    7.51 1.64e-13 ***
obs         0.937685   0.008235  113.86  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.03089 on 771 degrees of freedom
Multiple R-squared:  0.9439,    Adjusted R-squared:  0.9438 
F-statistic: 1.296e+04 on 1 and 771 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-16" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-16" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-16">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-16" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-16">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-16" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-16" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 396.40317    38.2110937                         elevation
4 125.84479     1.6429259                saga_wetness_index
6  96.17544     1.1791143           relative_slope_position
7  58.71039     0.6307038 vertical_distance_channel_network
5  42.42643     0.4575155                    catchment_area
3  25.28904     0.3291335                 profile_curvature
2  18.91727     0.2742642                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-16" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-16">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-16" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-16" specific-use="notebook-output">
    <preformat>    %IncMSE IncNodePurity                         Var.Names
1 396.40317    38.2110937                         elevation
4 125.84479     1.6429259                saga_wetness_index
6  96.17544     1.1791143           relative_slope_position
7  58.71039     0.6307038 vertical_distance_channel_network
5  42.42643     0.4575155                    catchment_area
3  25.28904     0.3291335                 profile_curvature
2  18.91727     0.2742642                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-16" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-16">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-16" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="U_Ag_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-16">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-16" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Agriculture&quot;,
        property = &quot;U&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-16" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>
<sub-article article-type="notebook" id="nb-17-nb-17">
<front-stub>
<title-group>
<article-title>h* (CIE chroma) Ag site RF_Regression</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Koiter</surname>
<given-names>Alex</given-names>
</name>
<string-name>Alex Koiter</string-name>

</contrib>
</contrib-group>
</front-stub>

<body>
<sec id="load-libraries-nb-17">
  <title>Load libraries</title>
  <sec id="nb-code-cell-1-nb-17" specific-use="notebook-code">
  <code language="r script">suppressPackageStartupMessages({
  library(tidyverse)
  library(randomForest)
  library(terra)
  library(caret)
  library(patchwork)
  library(sf)
})
  </code>
  </sec>
</sec>
<sec id="load-data-nb-17">
  <title>Load data</title>
  <sec id="nb-code-cell-2-nb-17" specific-use="notebook-code">
  <code language="r script"> attribute &lt;- c(&quot;elevation&quot;, &quot;plan_curvature&quot;, &quot;profile_curvature&quot;, &quot;saga_wetness_index&quot;, &quot;catchment_area&quot;, &quot;relative_slope_position&quot;, &quot;vertical_distance_channel_network&quot;)

data &lt;- read_csv(here::here(&quot;./notebooks/ag_terrain_data.csv&quot;), show_col_types = FALSE) %&gt;%
  select(&quot;x&quot;, &quot;y&quot;, &quot;h_col&quot;, any_of(attribute))
  </code>
  </sec>
</sec>
<sec id="map-soil-property-nb-17">
  <title>Map soil property</title>
  <sec id="nb-code-cell-3-nb-17" specific-use="notebook-code">
  <code language="r script">temp_rast &lt;- rast(data)
crs(x = temp_rast, warn=FALSE) &lt;- &quot;epsg:26914&quot;

coords &lt;- read_csv(here::here(&quot;./notebooks/coords.csv&quot;), show_col_types = FALSE) %&gt;% 
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;),  crs = 4326) %&gt;%
  st_transform(crs = 26914)

p1&lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = h_col)) +
  scale_fill_viridis_c(name = bquote(italic(&quot;h*&quot;)), breaks = seq(1.15, 1.25, 0.02)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)

p2 &lt;- ggplot() +
  tidyterra::geom_spatraster(data = temp_rast, aes(fill = elevation)) +
  scale_fill_viridis_c(name = &quot;Elevation (m)&quot;, option = &quot;inferno&quot;, limits = c(309, 312)) +
  geom_sf(data = filter(coords, site == &quot;Agriculture&quot;)) +
  theme_bw(base_size = 12) +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.position = &quot;bottom&quot;) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  ggspatial::annotation_scale(location = &quot;bl&quot;) +
  ggspatial::annotation_north_arrow(location = &quot;br&quot;)
  </code>
  </sec>
  <sec id="nb-code-cell-4-nb-17" specific-use="notebook-code">
  <code language="r script">p1+p2  
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-4-1.png" />
  </sec>
</sec>
<sec id="resampling-data-nb-17">
  <title>Resampling data</title>
  <p>Resolution from 1m by 1m to 10m by 10m</p>
  <sec id="nb-code-cell-5-nb-17" specific-use="notebook-code">
  <code language="r script">data &lt;- as.data.frame(resample(rast(data), rast(extent = ext(rast(data)), resolution = 10)))
  </code>
  </sec>
</sec>
<sec id="create-training-validation-and-testing-datasets-nb-17">
  <title>Create training, validation and testing datasets</title>
  <p>60 % of the data in the training data set 20 % of the data in the
  validation data set 20 % of the data in the testing data set</p>
  <sec id="nb-code-cell-6-nb-17" specific-use="notebook-code">
  <code language="r script">set.seed(123) # makes it reproducible

temp2 &lt;- data %&gt;%
  mutate(dataset = sample(c(&quot;train&quot;, &quot;validation&quot;, &quot;test&quot;), size = nrow(.), replace = TRUE, prob = c(0.6, 0.2, 0.2)))

train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) 

validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset)

test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset)
  </code>
  </sec>
</sec>
<sec id="feature-selection-nb-17">
  <title>Feature selection</title>
  <p>vifstep() calculates VIF for all variables, excludes the one with
  the highest VIF (if it is greater than the threshold), repeat the
  procedure until no variables with a VIF greater than th remains.</p>
  <sec id="nb-code-cell-7-nb-17" specific-use="notebook-code">
  <code language="r script">features &lt;- usdm::vifstep(select(filter(train, dataset == &quot;train&quot;), -dataset, -h_col), th = 8)
  </code>
  <code language="r script">features
  </code>
  <sec id="nb-code-cell-7-output-0-nb-17" specific-use="notebook-output">
  <preformat>The legacy packages maptools, rgdal, and rgeos, underpinning the sp package,
which was just loaded, will retire in October 2023.
Please refer to R-spatial evolution reports for details, especially
https://r-spatial.org/r/2023/05/15/evolution4.html.
It may be desirable to make the sf package available;
package maintainers should consider adding sf to Suggests:.
The sp package is now running under evolution status 2
     (status 2 uses the sf package in place of rgdal)</preformat>
  </sec>
  <sec id="nb-code-cell-7-output-1-nb-17" specific-use="notebook-output">
  <preformat>No variable from the 7 input variables has collinearity problem. 

The linear correlation coefficients ranges between: 
min correlation ( profile_curvature ~ elevation ):  0.002419244 
max correlation ( saga_wetness_index ~ elevation ):  -0.8977745 

---------- VIFs of the remained variables -------- 
                          Variables      VIF
1                         elevation 5.545539
2                    plan_curvature 1.350442
3                 profile_curvature 1.315861
4                saga_wetness_index 5.372984
5                    catchment_area 1.240758
6           relative_slope_position 2.262207
7 vertical_distance_channel_network 1.811908</preformat>
  </sec>
  </sec>
  <sec id="remove-correlated-features-from-the-data-sets-nb-17">
    <title>Remove correlated features from the data sets</title>
    <sec id="nb-code-cell-8-nb-17" specific-use="notebook-code">
    <code language="r script">train &lt;- temp2 %&gt;% 
  filter(dataset == &quot;train&quot; | dataset == &quot;validation&quot;) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">validation &lt;- temp2 %&gt;% 
  filter(dataset == &quot;validation&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <code language="r script">test &lt;- temp2 %&gt;% 
  filter(dataset == &quot;test&quot;) %&gt;%
  select(-dataset) %&gt;%
  usdm::exclude(features)
    </code>
    <sec id="nb-code-cell-8-output-0-nb-17" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-1-nb-17" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    <sec id="nb-code-cell-8-output-2-nb-17" specific-use="notebook-output">
    <preformat>Warning in usdm::exclude(., features): No variable to exclude!</preformat>
    </sec>
    </sec>
  </sec>
</sec>
<sec id="tune-the-training-rf-model-using-the-validation-dataset-nb-17">
  <title>Tune the training RF model using the validation dataset</title>
  <p>Instructions
  (https://stackoverflow.com/questions/18155482/how-to-specify-a-validation-holdout-set-to-caret)
  This uses the caret package and I included the validation set inside
  my training set and just define the resampling measures to only use
  the validation data. This step is to optimize the mtry parameter</p>
  <sec id="nb-code-cell-9-nb-17" specific-use="notebook-code">
  <code language="r script">tc &lt;- trainControl(method = &quot;cv&quot;, number = 1, index = list(Fold1 = which(train$dataset == &quot;train&quot;)), savePredictions = T)

set.seed(456)
validate.rf &lt;- train(h_col ~ ., data = select(train, -dataset), method = &quot;rf&quot;, trControl = tc)
plot(validate.rf)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-9-1.png" />
  <code language="r script">my_mtry &lt;- validate.rf$finalModel$mtry
my_mtry
  </code>
  <sec id="nb-code-cell-9-output-0-nb-17" specific-use="notebook-output">
  <preformat>[1] 4</preformat>
  </sec>
  </sec>
</sec>
<sec id="validation-back-test-nb-17">
  <title>Validation back test</title>
  <p>Uses the validation dataset as the test</p>
  <sec id="nb-code-cell-10-nb-17" specific-use="notebook-code">
  <code language="r script">set.seed(789)

rf.fit &lt;- randomForest(h_col ~ ., data = select(filter(train, dataset == &quot;train&quot;), -dataset), 
                       ntree = 500, keep.forest = TRUE, importance = TRUE, mtry = my_mtry,
                       ytest = select(filter(train, dataset == &quot;validation&quot;), -dataset)$h_col,
                       xtest = dplyr::select(select(filter(train, dataset == &quot;validation&quot;), -dataset), -h_col))
rf.fit
  </code>
  <sec id="nb-code-cell-10-output-0-nb-17" specific-use="notebook-output">
  <preformat>
Call:
 randomForest(formula = h_col ~ ., data = select(filter(train,      dataset == &quot;train&quot;), -dataset), ntree = 500, keep.forest = TRUE,      importance = TRUE, mtry = my_mtry, ytest = select(filter(train,          dataset == &quot;validation&quot;), -dataset)$h_col, xtest = dplyr::select(select(filter(train,          dataset == &quot;validation&quot;), -dataset), -h_col)) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 4

          Mean of squared residuals: 2.987127e-05
                    % Var explained: 58.2
                       Test set MSE: 0
                    % Var explained: 59.43</preformat>
  </sec>
  </sec>
  <sec id="nb-code-cell-11-nb-17" specific-use="notebook-code">
  <code language="r script">oob_val &lt;- sqrt(rf.fit$mse)
test_val &lt;- sqrt(rf.fit$test$mse)

val_plot &lt;- tibble(`Out of Bag Error` = oob_val,
                   Validation = test_val,
                   ntrees = 1:rf.fit$ntree) %&gt;%
  pivot_longer(cols = -ntrees, names_to = &quot;Metric&quot;, values_to = &quot;RMSE&quot; )

ggplot(data = val_plot, aes(ntrees, RMSE, color = Metric)) +
  geom_line() +
  theme_bw() +
  xlab(&quot;Number of trees&quot;)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-11-1.png" />
  </sec>
</sec>
<sec id="testing-the-rf-model-nb-17">
  <title>Testing the RF model</title>
  <p>Uses the RF model to predict the test dataset. We compare predicted
  against actual</p>
  <sec id="nb-code-cell-12-nb-17" specific-use="notebook-code">
  <code language="r script">prediction &lt;- predict(rf.fit, newdata = test)
test_plot &lt;- data.frame(pred = prediction, obs = test$h_col)

summary(lm(pred~obs, data = test_plot))
  </code>
  <code language="r script">ggplot(data = test_plot, aes(y = pred, x = obs)) +
  geom_point() +
  ggpmisc::stat_poly_line() +
  ggpmisc::stat_poly_eq() +
  theme_bw() +
  geom_abline(slope = 1, intercept = 0) +
  coord_fixed(ratio = 1)
  </code>
  <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-12-1.png" />
  <sec id="nb-code-cell-12-output-0-nb-17" specific-use="notebook-output">
  <preformat>
Call:
lm(formula = pred ~ obs, data = test_plot)

Residuals:
       Min         1Q     Median         3Q        Max 
-0.0160800 -0.0021674  0.0004545  0.0024295  0.0116053 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.62400    0.01834   34.03   &lt;2e-16 ***
obs          0.48198    0.01523   31.64   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.003727 on 771 degrees of freedom
Multiple R-squared:  0.5649,    Adjusted R-squared:  0.5643 
F-statistic:  1001 on 1 and 771 DF,  p-value: &lt; 2.2e-16</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-1-nb-17" specific-use="notebook-output">
  <preformat>Registered S3 methods overwritten by 'ggpp':
  method                  from   
  heightDetails.titleGrob ggplot2
  widthDetails.titleGrob  ggplot2</preformat>
  </sec>
  <sec id="nb-code-cell-12-output-2-nb-17" specific-use="notebook-output">
  <preformat>Registered S3 method overwritten by 'ggpmisc':
  method                  from   
  as.character.polynomial polynom</preformat>
  </sec>
  </sec>
</sec>
<sec id="importance-nb-17">
  <title>Importance</title>
  <sec id="nb-code-cell-13-nb-17" specific-use="notebook-code">
  <code language="r script">ImpData &lt;- as.data.frame(importance(rf.fit)) %&gt;%
  mutate(Var.Names = row.names(.)) %&gt;%
 `row.names&lt;-`(as.character(1:nrow(importance(rf.fit))))
  </code>
  </sec>
  <sec id="top-based-on-incnodepurity-nb-17">
    <title>Top based on IncNodePurity</title>
    <sec id="nb-code-cell-14-nb-17" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = IncNodePurity, n = 10)
    </code>
    <sec id="nb-code-cell-14-output-0-nb-17" specific-use="notebook-output">
    <preformat>   %IncMSE IncNodePurity                         Var.Names
4 92.79061    0.04377967                saga_wetness_index
1 92.18964    0.03834653                         elevation
7 66.71781    0.01944596 vertical_distance_channel_network
6 47.76518    0.01935051           relative_slope_position
5 55.86773    0.01841142                    catchment_area
3 39.69314    0.01338786                 profile_curvature
2 26.22748    0.01002262                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-15-nb-17" specific-use="notebook-code">
    <code language="r script">p1 &lt;- ggplot(slice_max(ImpData,order_by = IncNodePurity, n = 10), aes(x = fct_reorder(Var.Names, IncNodePurity), y = IncNodePurity)) +
  geom_segment(aes(x = fct_reorder(Var.Names, IncNodePurity), xend = fct_reorder(Var.Names, IncNodePurity), y = 0, yend = IncNodePurity), color=&quot;skyblue&quot;) +
  geom_point(aes(size = `%IncMSE`), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="top-10-based-on-incmse-nb-17">
    <title>Top 10 based on %IncMSE</title>
    <sec id="nb-code-cell-16-nb-17" specific-use="notebook-code">
    <code language="r script">slice_max(ImpData,order_by = `%IncMSE`, n = 10)
    </code>
    <sec id="nb-code-cell-16-output-0-nb-17" specific-use="notebook-output">
    <preformat>   %IncMSE IncNodePurity                         Var.Names
4 92.79061    0.04377967                saga_wetness_index
1 92.18964    0.03834653                         elevation
7 66.71781    0.01944596 vertical_distance_channel_network
5 55.86773    0.01841142                    catchment_area
6 47.76518    0.01935051           relative_slope_position
3 39.69314    0.01338786                 profile_curvature
2 26.22748    0.01002262                    plan_curvature</preformat>
    </sec>
    </sec>
    <sec id="nb-code-cell-17-nb-17" specific-use="notebook-code">
    <code language="r script">p2&lt;- ggplot(slice_max(ImpData,order_by = `%IncMSE`, n = 10), aes(x = fct_reorder(Var.Names, `%IncMSE`), y = `%IncMSE`)) +
  geom_segment(aes(x = fct_reorder(Var.Names, `%IncMSE`), xend = fct_reorder(Var.Names, `%IncMSE`), y = 0, yend = `%IncMSE`), color=&quot;skyblue&quot;) +
  geom_point(aes(size = IncNodePurity), color = &quot;blue&quot;, alpha = 0.6) +
  theme_bw() +
  coord_flip() +
  labs(x = &quot;Terrain Attribute&quot;) +
  theme(legend.position=&quot;bottom&quot;)
    </code>
    </sec>
  </sec>
  <sec id="combined-nb-17">
    <title>Combined</title>
    <sec id="nb-code-cell-18-nb-17" specific-use="notebook-code">
    <code language="r script">p1+p2
    </code>
    <graphic mimetype="image" mime-subtype="png" xlink:href="h_col_Ag_RF_regression_files/figure-jats/unnamed-chunk-18-1.png" />
    </sec>
  </sec>
  <sec id="write-data-nb-17">
    <title>Write data</title>
    <sec id="nb-code-cell-19-nb-17" specific-use="notebook-code">
    <code language="r script">importance_data &lt;- ImpData %&gt;%
  mutate(MSE_rank = rank(-`%IncMSE`)) %&gt;%
  mutate(Purity_rank = rank(-IncNodePurity)) %&gt;%
  mutate(site = &quot;Agriculture&quot;,
        property = &quot;h_col&quot;)

if(file.exists(here::here(&quot;./notebooks/importance_data.csv&quot;))) {
  importance_data_final &lt;- read_csv(here::here(&quot;./notebooks/importance_data.csv&quot;)) |&gt;
    rows_upsert(importance_data, by = c(&quot;MSE_rank&quot;, &quot;site&quot;, &quot;property&quot;)) 
} else importance_data_final &lt;- importance_data
    </code>
    <code language="r script">write_csv(importance_data_final, here::here(&quot;./notebooks/importance_data.csv&quot;))
    </code>
    <sec id="nb-code-cell-19-output-0-nb-17" specific-use="notebook-output">
    <preformat>Rows: 85 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: &quot;,&quot;
chr (3): Var.Names, site, property
dbl (4): %IncMSE, IncNodePurity, MSE_rank, Purity_rank

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</preformat>
    </sec>
    </sec>
  </sec>
</sec>
</body>



<back>
</back>


</sub-article>

</article>